CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Sub_Generate_Dominat_Cell`(IN GT_DB VARCHAR(100), IN KIND VARCHAR(20), IN VENDOR_SOURCE VARCHAR(20),IN GT_COVMO VARCHAR(100))
BEGIN
	DECLARE RNC_ID INT;
	DECLARE O_GT_DB VARCHAR(100) DEFAULT GT_DB;
	DECLARE START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE PARTITION_ID INT DEFAULT SUBSTRING(RIGHT(GT_DB,18),10,2) ;
	DECLARE SH_EH VARCHAR(9) DEFAULT RIGHT(GT_DB,9);
	DECLARE GT_DATE VARCHAR(18) DEFAULT RIGHT(GT_DB,18);
	DECLARE STARTHOUR VARCHAR(2) DEFAULT SUBSTRING(RIGHT(GT_DB,18),10,2);
	DECLARE ENDHOUR VARCHAR(2) DEFAULT IF(SUBSTRING(RIGHT(GT_DB,18),15,2)='00','24',SUBSTRING(RIGHT(GT_DB,18),15,2));
	DECLARE RUN VARCHAR(20);
	DECLARE WORKER_ID VARCHAR(10) DEFAULT CONNECTION_ID();
	
	DECLARE CURRENT_NT_DB VARCHAR(50) DEFAULT CONCAT('gt_nt_',gt_strtok(GT_DB,3,'_'));
	SET SESSION group_concat_max_len = 100000;
	
	SELECT gt_strtok(GT_DB,2,'_') INTO RNC_ID;
	CALL SP_Sub_Set_Session_Param(GT_DB);
	SELECT REPLACE(GT_DB,SH_EH,'0000_0000') INTO GT_DB;
	
	IF VENDOR_SOURCE = 'GW' THEN
		IF KIND = 'DAILY' THEN
			SET RUN = '_tmp';
		ELSEIF KIND = 'RERUN' THEN
			SET RUN = '_rerun';
		END IF;
	ELSEIF VENDOR_SOURCE = 'AP' THEN
		SET RUN = '';
	END IF;
	
	SET @SqlCmd=CONCAT('SELECT att_value INTO @ZOOM_LEVEL FROM ',GT_DB,RUN,'.`sys_config` WHERE `group_name`=''system'' AND att_name = ''MapResolution'';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('ALTER TABLE ',GT_DB,RUN,'.table_tile_domiant_cell TRUNCATE PARTITION h',PARTITION_ID,';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Sub_Generate_Dominat_Cell','CREATE temp TABLE tmp_table_tile_domiant_cell ', NOW());
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE  IF EXISTS ',GT_DB,RUN,'.tmp_table_tile_domiant_cell_',WORKER_ID,';');
	PREPARE stmt FROM @sqlcmd;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;
	
	SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE ',GT_DB,RUN,'.`tmp_table_tile_domiant_cell_',WORKER_ID,'` (
					`DATA_DATE` DATE DEFAULT NULL,
					`DATA_HOUR` TINYINT(4) DEFAULT NULL,
					`RNC_ID` MEDIUMINT(9) DEFAULT NULL,
					`CELL_ID` MEDIUMINT(9) DEFAULT NULL,
					`TILE_ID` BIGINT(20) DEFAULT NULL,
					`CELL_NAME` VARCHAR(50) CHARACTER SET utf8 DEFAULT NULL,
					`INDOOR` TINYINT(4) DEFAULT NULL,
					`MOVING` TINYINT(4) DEFAULT NULL,
					`FREQUENCY` SMALLINT(6) DEFAULT NULL,
					`UARFCN` MEDIUMINT(9) DEFAULT NULL,
					`CELL_LON` DOUBLE DEFAULT NULL,
					`CELL_LAT` DOUBLE DEFAULT NULL,
					`POS_FIRST_RSCP_SUM` INT(11) DEFAULT ''0'',
					`POS_FIRST_RSCP_CNT` DOUBLE DEFAULT NULL,
					`POS_FIRST_ECN0_SUM` INT(11) DEFAULT ''0'',
					`POS_FIRST_ECN0_CNT` DOUBLE DEFAULT NULL,
					`CALL_CNT` INT(11) DEFAULT ''0''
				) ENGINE=MYISAM DEFAULT CHARSET=latin1;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Sub_Generate_Dominat_Cell','INSERT INTO tmp_table_tile_domiant_cell ', NOW());
	
	SET @SqlCmd=CONCAT('INSERT INTO  ',GT_DB,RUN,'.`tmp_table_tile_domiant_cell_',WORKER_ID,'`
					(`DATA_DATE`,
					`DATA_HOUR`,
					`RNC_ID`,
					`CELL_ID`,
					`TILE_ID`,
					`INDOOR`,
					`MOVING`,
					`FREQUENCY`,
					`UARFCN`,
					`CELL_LON`,
					`CELL_LAT`,
					`POS_FIRST_RSCP_SUM`,
					`POS_FIRST_RSCP_CNT`,
					`POS_FIRST_ECN0_SUM`,
					`POS_FIRST_ECN0_CNT`,
					`CALL_CNT`)
			    SELECT
					 DATA_DATE
					, DATA_HOUR
					, RNC_ID
					, CELL_ID
					, TILE_ID
					, INDOOR
					, MOVING
					, FREQUENCY
					, UARFCN
					, CELL_LON
					, CELL_LAT
					, SUM(BEST_RSCP_1)*SUM(BEST_RSCP_1_CNT) AS POS_FIRST_RSCP_SUM
					, SUM(BEST_RSCP_1_CNT) AS POS_FIRST_RSCP_CNT
					, SUM(BEST_ECN0_1)*SUM(BEST_ECN0_1_CNT) AS POS_FIRST_ECN0_SUM
					, SUM(BEST_ECN0_1_CNT) AS POS_FIRST_ECN0_CNT
					, SUM(CALL_CNT) AS CALL_CNT
				FROM ',GT_DB,RUN,'.table_tile_start
				WHERE DATA_HOUR >= ',STARTHOUR,' AND DATA_HOUR < ',ENDHOUR,'
				GROUP BY  DATA_DATE
					, DATA_HOUR
					, RNC_ID
					, CELL_ID
					, TILE_ID
					, INDOOR
					, MOVING
					, FREQUENCY
					, UARFCN
					, CELL_LON
					, CELL_LAT
				ORDER BY NULL');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Sub_Generate_Dominat_Cell','UPDATE cell infor', NOW());
	SET @SqlCmd=CONCAT(' UPDATE ',GT_DB,RUN,'.`tmp_table_tile_domiant_cell_',WORKER_ID,'` A, 
				    ',CURRENT_NT_DB,'.nt_current B
			     SET A.CELL_NAME=B.CELL_NAME
				WHERE A.RNC_ID=B.RNC_ID
				AND A.CELL_ID=B.CELL_ID
				AND DATA_HOUR >= ',STARTHOUR,' AND DATA_HOUR < ',ENDHOUR,';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;	
		
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Sub_Generate_Dominat_Cell','INSERT INTO table_tile_domiant_cell ', NOW());
	SET @SqlCmd=CONCAT('INSERT INTO  ',GT_DB,RUN,'.table_tile_domiant_cell
				(`DATA_DATE`,`DATA_HOUR`,`RNC_ID`,`CELL_ID`,`TILE_ID`,`CELL_NAME`,`INDOOR`,
				`MOVING`,`FREQUENCY`,`UARFCN`,`CELL_LON`,`CELL_LAT`,`POS_FIRST_RSCP_SUM`,
				`POS_FIRST_RSCP_CNT`,`POS_FIRST_ECN0_SUM`,`POS_FIRST_ECN0_CNT`,`CALL_CNT`)
			SELECT 
				`DATA_DATE`,`DATA_HOUR`,`RNC_ID`,`CELL_ID`,`TILE_ID`,`CELL_NAME`,`INDOOR`,
				`MOVING`,`FREQUENCY`,`UARFCN`,`CELL_LON`,`CELL_LAT`,`POS_FIRST_RSCP_SUM`,
				`POS_FIRST_RSCP_CNT`,`POS_FIRST_ECN0_SUM`,`POS_FIRST_ECN0_CNT`,`CALL_CNT`
			FROM ',GT_DB,RUN,'.`tmp_table_tile_domiant_cell_',WORKER_ID,'`;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS   ',GT_DB,RUN,'.tmp_table_tile_ul_thru_high_dy_c_def_',WORKER_ID,' ');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Sub_Generate_Dominat_Cell',CONCAT('Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());
	
		
END
utf8
utf8_general_ci
latin1_swedish_ci
