CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Generate_Global_Statistic_cell_lte`(IN DATA_DATE DATE,IN DATA_HOUR TINYINT(2),IN PU_ID MEDIUMINT(9),IN TECH_MASK TINYINT(2), IN GT_DB VARCHAR(100))
BEGIN
	DECLARE SP_Process VARCHAR(100) DEFAULT NULL;
	DECLARE WORKER_ID VARCHAR(10) DEFAULT CONNECTION_ID();
	DECLARE Spider_SP_ERROR CONDITION FOR SQLSTATE '99998';
	DECLARE KPI_ERROR CONDITION FOR SQLSTATE '99999' ;
	DECLARE NT_DB VARCHAR(100);
	SET NT_DB =CONCAT('gt_nt_',gt_strtok(GT_DB,3,'_'));
	
	INSERT INTO gt_gw_main.sp_log VALUES('gt_gw_main','SP_Generate_Global_Statistic_cell_lte',CONCAT(GT_DB,' CREATE TEMPORARY TABLE tmp_materialization_',WORKER_ID), NOW());	
	
	SET SESSION group_concat_max_len=102400; 
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS ',GT_DB,'.tmp_materialization_',WORKER_ID,';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE ',GT_DB,'.tmp_materialization_',WORKER_ID,' 
					(
						  `DATA_DATE` DATE NOT NULL DEFAULT ''0000-00-00'',
						  `DATA_HOUR` TINYINT(4) NOT NULL DEFAULT ''0'',
						  `PU_ID` MEDIUMINT(9) NOT NULL DEFAULT ''0'',
						  `ENODEB_ID` MEDIUMINT(9) NOT NULL DEFAULT ''0'',
						  `CELL_ID` MEDIUMINT(9) NOT NULL DEFAULT ''0'',
						  `CELL_NAME` VARCHAR(50) CHARACTER SET utf8 DEFAULT NULL COMMENT ''lookup'',
						  `SUB_REGION_ID` MEDIUMINT(9) NOT NULL DEFAULT ''0'',
						  `EUTRABAND` SMALLINT(6) DEFAULT NULL,
						  `EARFCN` MEDIUMINT(9) DEFAULT NULL,
						  `CELL_OSS_NODE_ID` INT(20) DEFAULT NULL,
						  `RRC_CONN_SETUP_ATTEMPT` MEDIUMINT(8) DEFAULT ''0'',
						  `RRC_CONN_SETUP_REJECT` MEDIUMINT(8) DEFAULT ''0'',
						  `RRC_CONN_SETUP_MISSING_COMPLETE` MEDIUMINT(8) DEFAULT ''0'',
						  `ERAB_SETUP_ATTEMPT` MEDIUMINT(8) DEFAULT ''0'',
						  `ERAB_SETUP_REJECT` MEDIUMINT(8) DEFAULT ''0'',
						  `ERAB_SETUP_ACCS_DELAY` MEDIUMINT(8) DEFAULT ''0'',
						  `UE_CNXT_DROP_SETUP` MEDIUMINT(8) DEFAULT ''0'',
						  `UE_CNXT_DROP_DROP` MEDIUMINT(8) DEFAULT ''0'',
						  `RRC_RE_ESTABLISHMENT_ATTEMPT` MEDIUMINT(8) DEFAULT ''0'',
						  `RRC_RE_ESTABLISHMENT_FAILURE` MEDIUMINT(8) DEFAULT ''0'',
						  `MIMO_USAGE_RATIO_NUM` MEDIUMINT(8) DEFAULT NULL,
						  `MIMO_USAGE_RATIO_DEN` MEDIUMINT(8) DEFAULT NULL,
						  `SUBSC_PET_CELL_PER_HR` FLOAT DEFAULT NULL,
						  `CALL_DURATION_SUM` MEDIUMINT(8) DEFAULT ''0'',	
						  `CALL_DURATION_CNT` MEDIUMINT(8) DEFAULT ''0'',
						  `4G_4G_HO_ATTEMPT` MEDIUMINT(8) DEFAULT ''0'',
						  `4G_4G_HO_FAILURE` MEDIUMINT(8) DEFAULT ''0'',
						  `RRC_RECONFIGURATION_ATTEMPT` MEDIUMINT(8) DEFAULT ''0'',
						  `RRC_RECONFIGURATION_FAILURE` MEDIUMINT(8) DEFAULT ''0'',
						  `CSFB_EXECUTIONS` MEDIUMINT(8) DEFAULT ''0'',
						  `UE_CNXT_REL_TOT` MEDIUMINT(8) DEFAULT ''0'',
						  `IRAT_PING_PONG` float DEFAULT NULL,
						  `IRAT_RSRP` float DEFAULT NULL,
						  `IRAT_RSRQ` float DEFAULT NULL,
						  `IRAT_TA` float DEFAULT NULL,
						  `IRAT_RSCP` float DEFAULT NULL,
						  `IRAT_ECN0` float DEFAULT NULL,
						  `IRAT_RSSI` float DEFAULT NULL,
						  `4G_3G_HO_ATTEMPT` MEDIUMINT(8) DEFAULT ''0'',
						  `4G_3G_HO_FAILURE` MEDIUMINT(8) DEFAULT ''0'',
						  `4G_2G_HO_ATTEMPT` MEDIUMINT(8) DEFAULT ''0'',
						  `4G_2G_HO_FAILURE` MEDIUMINT(8)  DEFAULT ''0'',
						  `BLIND_REDIR_4G_3G` MEDIUMINT(8)  DEFAULT ''0'',
						  `BLIND_REDIR_4G_2G` MEDIUMINT(8)  DEFAULT ''0'',
						  `4G_3G_CSFB_HO_ATT`  MEDIUMINT(8)  DEFAULT ''0'',
						  `4G_3G_CSFB_HO_SUCC` MEDIUMINT(8)  DEFAULT ''0'',
						  `4G_3G_CSFB_HO_FAILURE` MEDIUMINT(8)  DEFAULT ''0'',
						  `VOLTE_ATTEMPT`  MEDIUMINT(8)  DEFAULT ''0'',
						  `VOLTE_SUCCESS` MEDIUMINT(8)  DEFAULT ''0'',
						  `VOLTE_FAILURE` MEDIUMINT(8)  DEFAULT ''0'',
						  `PROCEDURE_TIME_SUM` MEDIUMINT(8)  DEFAULT ''0'',
						  `PROCEDURE_TIME_CNT` MEDIUMINT(8)  DEFAULT ''0'',
						  `ACCESSIBILITY_TIME_SUM` MEDIUMINT(8)  DEFAULT ''0'',
						  `ACCESSIBILITY_TIME_CNT` MEDIUMINT(8)  DEFAULT ''0'',
						  `IRAT_RSRP_CNT` MEDIUMINT(8) DEFAULT ''0'',
						  `IRAT_RSRQ_CNT` MEDIUMINT(8) DEFAULT ''0'',
						  `IRAT_TA_CNT` MEDIUMINT(8) DEFAULT ''0'',
						  `IRAT_RSCP_CNT` MEDIUMINT(8) DEFAULT ''0'',
						  `IRAT_ECN0_CNT` MEDIUMINT(8) DEFAULT ''0'',
						  `IRAT_RSSI_CNT` MEDIUMINT(8) DEFAULT ''0'',
						`PEAK_SUBSCRIBER` MEDIUMINT(8) DEFAULT ''0'',
						`PEAK_QUARTER` CHAR(4) DEFAULT ''0''
					,PRIMARY KEY (`ENODEB_ID`,`CELL_ID`,`DATA_DATE`,`DATA_HOUR`,PU_ID,SUB_REGION_ID)	
					,KEY IX_CELL_ID (`DATA_HOUR`,`ENODEB_ID`,`CELL_ID`,PU_ID)
				) ENGINE=MyISAM DEFAULT CHARSET=utf8;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES('gt_gw_main','SP_Generate_Global_Statistic_cell_lte',CONCAT(GT_DB,' INSERT INTO tbl_',GT_DB,'_',WORKER_ID), NOW());	
	 
	
	SET @SqlCmd=CONCAT('INSERT INTO ',GT_DB,'.tmp_materialization_',WORKER_ID,'
				(	
				`DATA_DATE`,
				`DATA_HOUR`,
				`PU_ID`,
				`ENODEB_ID,
				`CELL_ID`,
				`CELL_NAME`,
				`RRC_CONN_SETUP_ATTEMPT`,
				`RRC_CONN_SETUP_REJECT`,
				`RRC_CONN_SETUP_MISSING_COMPLETE`,
				`ERAB_SETUP_ATTEMPT`,
				`ERAB_SETUP_REJECT`,
				`ERAB_SETUP_ACCS_DELAY`,
				`UE_CNXT_DROP_SETUP`,
				`UE_CNXT_DROP_DROP`,
				`RRC_RE_ESTABLISHMENT_ATTEMPT`,
				`RRC_RE_ESTABLISHMENT_FAILURE`,
				`MIMO_USAGE_RATIO_NUM`,
				`MIMO_USAGE_RATIO_DEN`,
				`SUBSC_PET_CELL_PER_HR`,
				`CALL_DURATION_SUM`,
				`CALL_DURATION_CNT`,
				`4G_4G_HO_ATTEMPT`,
				`4G_4G_HO_FAILURE`,
				`RRC_RECONFIGURATION_ATTEMPT`,
				`RRC_RECONFIGURATION_FAILURE`,
				`CSFB_EXECUTIONS`,
				`UE_CNXT_REL_TOT`,
				`IRAT_PING_PONG`,
				`IRAT_RSRP`,
				`IRAT_RSRQ`,
				`IRAT_TA`,
				`IRAT_RSCP`,
				`IRAT_ECN0`,
				`IRAT_RSSI`,
				`4G_3G_HO_ATTEMPT`,
				`4G_3G_HO_FAILURE`,
				`4G_2G_HO_ATTEMPT`,
				`4G_2G_HO_FAILURE`,
				`BLIND_REDIR_4G_3G`,
				`BLIND_REDIR_4G_2G`,
				`4G_3G_CSFB_HO_ATT`,
				`4G_3G_CSFB_HO_SUCC`,
				`4G_3G_CSFB_HO_FAILURE`,
				`VOLTE_ATTEMPT`,
				`VOLTE_SUCCESS`,
				`VOLTE_FAILURE`,
				`PROCEDURE_TIME_SUM`,
				`PROCEDURE_TIME_CNT`,
				`ACCESSIBILITY_TIME_SUM`,
				`ACCESSIBILITY_TIME_CNT`,
				`IRAT_RSRP_CNT`,
				`IRAT_RSRQ_CNT`,
				`IRAT_TA_CNT`,
				`IRAT_RSCP_CNT`,
				`IRAT_ECN0_CNT`,
				`IRAT_RSSI_CNT`,
				`PEAK_SUBSCRIBER`,
				`PEAK_QUARTER`,
				`VOLTE_DROP`,
				`VOLTE_END`,
				`DL_VOLUME_SUM`,
				`UL_VOLUME_SUM`,
				`DL_THROUGHPUT_SUM`,
				`DL_THROUGHPUT_CNT`,
				`UL_THROUGHPUT_SUM`,
				`UL_THROUGHPUT_CNT`,
				`DL_THROUGHPUT_MAX`,
				`UL_THROUGHPUT_MAX`,
				`DL_TRAFFIC_DUR`,
				`UL_TRAFFIC_DUR`
				)
			SELECT 
				a.DATA_DATE, 
				a.DATA_HOUR,
				a.PU_ID, 
				a.ENODEB_ID,
				a.CELL_ID,
				a.CELL_NAME,
				SUM(IFNULL(a.RRC_CONN_REQ,0)) AS RRC_CONN_SETUP_ATTEMPT,
				SUM(IFNULL(a.RRC_CONN_REJ,0)) AS RRC_CONN_SETUP_REJECT,
				SUM(IFNULL(a.RRC_CONN_SETUP,0) -IFNULL(RRC_CONN_REJ,0)- IFNULL(RRC_CONN_SETUP_COMPLETE,0)) AS RRC_CONN_SETUP_MISSING_COMPLETE,
				SUM(IFNULL(a.ERAB_SETUP_ATT,0) +IFNULL(INIT_CNXT_SETUP_ATT,0)) AS ERAB_SETUP_ATTEMPT,
				SUM(IFNULL(a.ERAB_SETUP_ATT,0) -IFNULL(ERAB_SETUP_SUCC,0)+ IFNULL(INIT_CNXT_SETUP_FAIL,0)) AS ERAB_SETUP_REJECT,
				SUM(IFNULL(a.ERAB_ACCESS_DELAY,0)) AS ERAB_SETUP_ACCS_DELAY,
				SUM(IFNULL(a.UE_CNXT_REL_NORMAL,0)+IFNULL(UE_CNXT_REL_ABNORMAL,0)) AS UE_CNXT_DROP_SETUP,
				SUM(IFNULL(a.UE_CNXT_REL_ABNORMAL,0)) AS UE_CNXT_DROP_DROP,
				SUM(IFNULL(a.RRC_CONN_REEST_ATT,0)) AS RRC_RE_ESTABLISHMENT_ATTEMPT,
				SUM(IFNULL(a.RRC_CONN_REEST_FAIL,0)) AS RRC_RE_ESTABLISHMENT_FAILURE,
				SUM((IFNULL(a.Rrc_Conn_Reconfig_MIMO,0) + IFNULL(Rrc_Conn_Setup_MIMO,0))) AS MIMO_USAGE_RATIO_NUM,
				SUM((IFNULL(a.RRC_CONN_RECONFIG_NOT_MIMO,0) + IFNULL(Rrc_Conn_Setup_Not_MIMO,0) +IFNULL(Rrc_Conn_Reconfig_MIMO,0) + IFNULL(Rrc_Conn_Setup_MIMO,0))) AS MIMO_USAGE_RATIO_DEN,
				SUM(IFNULL(a.SUBSCRIBER,0)) AS SUBSC_PET_CELL_PER_HR,
				SUM(IFNULL(a.CALL_DURATION_SUM,0)) AS CALL_DURATION_SUM,
				SUM(IFNULL(a.CALL_DURATION_CNT,0)) AS CALL_DURATION_CNT, 
				SUM(IFNULL(a.4G_4G_HO_S1_ATT,0)+IFNULL(4G_4G_HO_X2_ATT,0)) AS 4G_4G_HO_ATTEMPT,
				SUM(IFNULL(a.4G_4G_HO_S1_FAIL,0)+IFNULL(4G_4G_HO_X2_FAIL,0)) AS 4G_4G_HO_FAILURE,
				SUM(a.RRC_CONN_RECONFIG_ATT) AS RRC_RECONFIGURATION_ATTEMPT,
				SUM(a.RRC_CONN_RECONFIG_FAIL) AS RRC_RECONFIGURATION_FAILURE,
				SUM(a.UE_CNXT_REL_CSFB) AS CSFB_EXECUTIONS,
				SUM(a.UE_CNXT_REL_TOT) AS UE_CNXT_REL_TOT,
				SUM(a.IRAT_PING_PONG) AS IRAT_PING_PONG,
				SUM(a.RSRP_IRAT) AS IRAT_RSRP,
				SUM(a.RSRQ_IRAT) AS IRAT_RSRQ,
				SUM(a.TA) AS IRAT_TA,
				SUM(a.RSCP_IRAT) AS IRAT_RSCP,
				SUM(a.ECNO_IRAT) AS IRAT_ECN0,
				SUM(a.RSSI_IRAT) AS IRAT_RSSI,
				SUM(a.4G_3G_HO_ATT) AS 4G_3G_HO_ATTEMPT,
				SUM(a.4G_3G_HO_FAIL) AS 4G_3G_HO_FAILURE,
				SUM(a.4G_2G_HO_ATT) AS 4G_2G_HO_ATTEMPT,
				SUM(a.4G_2G_HO_FAIL) AS 4G_2G_HO_FAILURE,
				SUM(a.BLIND_REDIR_4G_3G),
				SUM(a.BLIND_REDIR_4G_2G),
				SUM(a.4G_3G_CSFB_HO_ATT),
				SUM(a.4G_3G_CSFB_HO_SUCC),
				SUM(a.4G_3G_CSFB_HO_FAILURE),
				SUM(a.VOLTE_ATTEMPT),
				SUM(a.VOLTE_SUCCESS),
				SUM(a.VOLTE_FAILURE),
				SUM(a.PROCEDURE_TIME_SUM),
				SUM(a.PROCEDURE_TIME_CNT),
				SUM(a.ACCESSIBILITY_TIME_SUM),
				SUM(a.ACCESSIBILITY_TIME_CNT),
				COUNT(a.RSRP_IRAT) AS IRAT_RSRP_CNT,
				COUNT(a.RSRQ_IRAT) AS IRAT_RSRQ_CNT,
				COUNT(a.TA) AS IRAT_TA_CNT,
				COUNT(a.RSCP_IRAT) AS IRAT_RSCP_CNT,
				COUNT(a.ECNO_IRAT) AS IRAT_ECN0_CNT,
				COUNT(a.RSSI_IRAT) AS IRAT_RSSI_CNT,
				MAX(IFNULL(a.PEAK_SUBSCRIBER,0)) AS PEAK_SUBSCRIBER,
				MAX(IFNULL(a.PEAK_QUARTER,0)) AS PEAK_QUARTER
				SUM(a.VOLTE_DROP),
				SUM(a.VOLTE_END),
				b.DL_VOLUME_SUM,
				b.UL_VOLUME_SUM,
				b.DL_THROUPUT_SUM,
				b.DL_THROUPUT_CNT,
				b.UL_THROUPUT_SUM,
				b.UL_THROUPUT_CNT,
				b.DL_THROUPUT_MAX,
				b.UL_THROUPUT_MAX,
				b.DL_TRAFFIC_DUR,
				b.UL_TRAFFIC_DUR 
				FROM ',GT_DB,'.table_cell_lte a LEFT JOIN ',GT_DB,'.rpt_cell_position_dy_def b ON a.ENODEB_ID=b.ENODEB_ID AND a.CELL_ID=b.CELL_ID AND a.DATA_HOUR=b.DATA_HOUR
				WHERE a.DATA_HOUR = ',DATA_HOUR,'
				AND a.RRC_CONN_REQ > 0
				GROUP BY ENODEB_ID,CELL_ID,DATA_DATE,DATA_HOUR
				ORDER BY NULL;
				');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;	
	
	
	SET @SqlCmd=CONCAT('UPDATE ',GT_DB,'.tmp_materialization_',WORKER_ID,' a,',NT_DB,'.nt_cell_current_lte b
			SET  a.SUB_REGION_ID = b.SUB_REGION_ID,
			     a.EUTRABAND = b.EUTRABAND,
			     a.EARFCN = b.DL_EARFCN,
			     a.CELL_OSS_NODE_ID= b.CELL_OSS_NODE_ID
			WHERE a.CELL_ID =b.cell_id
			and a.ENODEB_ID =b.ENODEB_ID;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('SELECT * FROM ',GT_DB,'.tmp_materialization_',WORKER_ID,' WHERE ENODEB_ID>0;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS ',GT_DB,'.tmp_materialization_',WORKER_ID,';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES('gt_gw_main','SP_Generate_Global_Statistic_cell_lte',CONCAT(GT_DB,' End'), NOW());
	
    END
utf8
utf8_general_ci
latin1_swedish_ci
