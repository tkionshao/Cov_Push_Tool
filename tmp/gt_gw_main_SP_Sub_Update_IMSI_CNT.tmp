CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Sub_Update_IMSI_CNT`(IN GT_DB VARCHAR(100), IN KIND VARCHAR(20), IN VENDOR_SOURCE VARCHAR(20), IN RTYPE CHAR(1))
BEGIN
	DECLARE RNC_ID INT;
	DECLARE O_GT_DB VARCHAR(100) DEFAULT GT_DB;
	DECLARE START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE SH_EH VARCHAR(9) DEFAULT RIGHT(GT_DB,9);
	DECLARE STARTHOUR VARCHAR(2) DEFAULT SUBSTRING(RIGHT(GT_DB,18),10,2);
	DECLARE ENDHOUR VARCHAR(2) DEFAULT IF(SUBSTRING(RIGHT(GT_DB,18),15,2)='00','24',SUBSTRING(RIGHT(GT_DB,18),15,2));
	DECLARE RUN VARCHAR(20);
	DECLARE WORKER_ID VARCHAR(10) DEFAULT CONNECTION_ID();
	
	SELECT gt_strtok(GT_DB,2,'_') INTO RNC_ID;
	SELECT REPLACE(GT_DB,SH_EH,'0000_0000') INTO GT_DB;
	
	IF VENDOR_SOURCE = 'GW' THEN
		IF KIND = 'DAILY' THEN
			SET RUN = '_tmp';
		ELSEIF KIND = 'RERUN' THEN
			SET RUN = '_rerun';
		END IF;
	ELSEIF VENDOR_SOURCE = 'AP' THEN
		SET RUN = '';
	END IF;
	
	
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Update_IMSI_CNT','Start', NOW());
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE  IF EXISTS ',GT_DB,RUN,'.tmp_imsi_distinct_',WORKER_ID,';');
	PREPARE stmt FROM @sqlcmd;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;
	
	IF RTYPE = 'h' THEN
		INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Sub_Update_IMSI_CNT','hourly', NOW());
	
		SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'` (
					`DATA_DATE` DATE DEFAULT NULL,
					`DATA_HOUR` TINYINT(4) DEFAULT NULL,
					`INDOOR` TINYINT(4) DEFAULT NULL,
					`MOVING` TINYINT(4) DEFAULT NULL,
					`RNC_ID` MEDIUMINT(9) DEFAULT NULL,
					`CELL_ID` MEDIUMINT(9) DEFAULT NULL,
					`CALL_TYPE` TINYINT(4) DEFAULT NULL,
					`CALL_STATUS` TINYINT(4) DEFAULT NULL,
					`IMSI` VARCHAR(20) DEFAULT NULL
					) ENGINE=MYISAM DEFAULT CHARSET=latin1;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		SET @SqlCmd=CONCAT('INSERT INTO  ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'`
					(`DATA_DATE`,`DATA_HOUR`,`INDOOR`,`MOVING`,`RNC_ID`,`CELL_ID`,`CALL_TYPE`,`CALL_STATUS`,`IMSI`
					 )
				    SELECT
						 DATA_DATE
						, DATA_HOUR
						, INDOOR
						, MOVING
						, POS_FIRST_RNC AS RNC_ID
						, POS_FIRST_CELL AS CELL_ID
						, CALL_TYPE 
						, CALL_STATUS
						, IMSI
					FROM ',GT_DB,RUN,'.table_call
					WHERE POS_FIRST_RNC =',RNC_ID,'
					AND DATA_HOUR >= ',STARTHOUR,' AND DATA_HOUR < ',ENDHOUR,'
					GROUP BY  DATA_DATE
						, DATA_HOUR
						, INDOOR
						, MOVING
						, POS_FIRST_RNC
						, POS_FIRST_CELL
						, CALL_TYPE 
						, CALL_STATUS
						, IMSI
					ORDER BY NULL');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Sub_Update_IMSI_CNT','Update SUB_DENSITY', NOW());
	
	
	
		SET @SqlCmd=CONCAT(' UPDATE ',GT_DB,RUN,'.table_tile_start_c A,
		(
				    SELECT
						 DATA_DATE
						, DATA_HOUR
						, INDOOR
						, MOVING
						, RNC_ID
						, CELL_ID
						, CALL_TYPE 
						, CALL_STATUS
						, COUNT(DISTINCT IMSI) AS SUB_DENSITY
					FROM ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'` 
					GROUP BY  DATA_DATE
						, DATA_HOUR
						, INDOOR
						, MOVING
						, RNC_ID
						, CELL_ID
						, CALL_TYPE 
						, CALL_STATUS
		) B
					SET 	A.SUB_DENSITY=B.SUB_DENSITY
					WHERE   A.DATA_DATE = B.DATA_DATE
						AND A.DATA_HOUR = B.DATA_HOUR
						AND A.INDOOR = B.INDOOR
						AND A.MOVING = B.MOVING
						AND A.RNC_ID = B.RNC_ID
						AND A.CELL_ID = B.CELL_ID
						AND A.CALL_TYPE  = B.CALL_TYPE
						AND A.CALL_STATUS = B.CALL_STATUS;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	
		SET @SqlCmd=CONCAT(' UPDATE ',GT_DB,RUN,'.table_tile_start_c_def A,
		(
				    SELECT
						 DATA_DATE
						, DATA_HOUR
						, RNC_ID
						, CELL_ID
						, COUNT(DISTINCT IMSI) AS SUB_DENSITY
					FROM ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'` 
					GROUP BY  DATA_DATE
						, DATA_HOUR
						, RNC_ID
						, CELL_ID
		) B
					SET 	A.SUB_DENSITY=B.SUB_DENSITY
					WHERE   A.DATA_DATE = B.DATA_DATE
						AND A.DATA_HOUR = B.DATA_HOUR
						AND A.RNC_ID = B.RNC_ID
						AND A.CELL_ID = B.CELL_ID;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	
	
	
		SET @SqlCmd=CONCAT(' UPDATE ',GT_DB,'.table_tile_start_dy_c A,
		(
				    SELECT
						 DATA_DATE
						, INDOOR
						, MOVING
						, RNC_ID
						, CELL_ID
						, CALL_TYPE 
						, CALL_STATUS
						, COUNT(DISTINCT IMSI) AS SUB_DENSITY
					FROM ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'` 
					GROUP BY  DATA_DATE
						, INDOOR
						, MOVING
						, RNC_ID
						, CELL_ID
						, CALL_TYPE 
						, CALL_STATUS
		) B
					SET 	A.SUB_DENSITY = CASE WHEN IFNULL(A.SUB_DENSITY,0) > B.SUB_DENSITY THEN A.SUB_DENSITY ELSE B.SUB_DENSITY END
					WHERE   A.DATA_DATE = B.DATA_DATE
						AND A.INDOOR = B.INDOOR
						AND A.MOVING = B.MOVING
						AND A.RNC_ID = B.RNC_ID
						AND A.CELL_ID = B.CELL_ID
						AND A.CALL_TYPE  = B.CALL_TYPE
						AND A.CALL_STATUS = B.CALL_STATUS;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		SET @SqlCmd=CONCAT(' UPDATE ',GT_DB,'.table_tile_start_dy_c_def A,
		(
				    SELECT
						 DATA_DATE
						, RNC_ID
						, CELL_ID
						, COUNT(DISTINCT IMSI) AS SUB_DENSITY
					FROM ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'` 
					GROUP BY  DATA_DATE
						, RNC_ID
						, CELL_ID
		) B
					SET 	A.SUB_DENSITY = CASE WHEN IFNULL(A.SUB_DENSITY,0) > B.SUB_DENSITY THEN A.SUB_DENSITY ELSE B.SUB_DENSITY END
					WHERE   A.DATA_DATE = B.DATA_DATE
						AND A.RNC_ID = B.RNC_ID
						AND A.CELL_ID = B.CELL_ID');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	
	ELSEIF RTYPE = 'd' THEN
		INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Sub_Update_IMSI_CNT','daily', NOW());
	
		SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'` (
					`DATA_DATE` DATE DEFAULT NULL,
					`INDOOR` TINYINT(4) DEFAULT NULL,
					`MOVING` TINYINT(4) DEFAULT NULL,
					`RNC_ID` MEDIUMINT(9) DEFAULT NULL,
					`CELL_ID` MEDIUMINT(9) DEFAULT NULL,
					`CALL_TYPE` TINYINT(4) DEFAULT NULL,
					`CALL_STATUS` TINYINT(4) DEFAULT NULL,
					`IMSI` VARCHAR(20) DEFAULT NULL
					) ENGINE=MYISAM DEFAULT CHARSET=latin1;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		SET @SqlCmd=CONCAT('INSERT INTO  ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'`
					(`DATA_DATE`,`INDOOR`,`MOVING`,`RNC_ID`,`CELL_ID`,`CALL_TYPE`,`CALL_STATUS`,`IMSI`
					 )
				    SELECT
						 DATA_DATE
						, INDOOR
						, MOVING
						, POS_FIRST_RNC AS RNC_ID
						, POS_FIRST_CELL AS CELL_ID
						, CALL_TYPE 
						, CALL_STATUS
						, IMSI
					FROM ',GT_DB,RUN,'.table_call
					WHERE POS_FIRST_RNC =',RNC_ID,'
					GROUP BY  DATA_DATE
						, INDOOR
						, MOVING
						, POS_FIRST_RNC
						, POS_FIRST_CELL
						, CALL_TYPE 
						, CALL_STATUS
						, IMSI
					ORDER BY NULL');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Sub_Update_IMSI_CNT','Update SUB_DENSITY', NOW());
		SET @SqlCmd=CONCAT(' UPDATE ',GT_DB,'.table_tile_start_dy_c A,
		(
				    SELECT
						 DATA_DATE
						, INDOOR
						, MOVING
						, RNC_ID
						, CELL_ID
						, CALL_TYPE 
						, CALL_STATUS
						, COUNT(DISTINCT IMSI) AS SUB_DENSITY
					FROM ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'` 
					GROUP BY  DATA_DATE
						, INDOOR
						, MOVING
						, RNC_ID
						, CELL_ID
						, CALL_TYPE 
						, CALL_STATUS
		) B
					SET 	A.SUB_DENSITY = B.SUB_DENSITY
					WHERE   A.DATA_DATE = B.DATA_DATE
						AND A.INDOOR = B.INDOOR
						AND A.MOVING = B.MOVING
						AND A.RNC_ID = B.RNC_ID
						AND A.CELL_ID = B.CELL_ID
						AND A.CALL_TYPE  = B.CALL_TYPE
						AND A.CALL_STATUS = B.CALL_STATUS;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		SET @SqlCmd=CONCAT(' UPDATE ',GT_DB,'.table_tile_start_dy_c_def A,
		(
				    SELECT
						 DATA_DATE
						, RNC_ID
						, CELL_ID
						, COUNT(DISTINCT IMSI) AS SUB_DENSITY
					FROM ',GT_DB,RUN,'.`tmp_imsi_distinct_',WORKER_ID,'` 
					GROUP BY  DATA_DATE
						, RNC_ID
						, CELL_ID
		) B
					SET 	A.SUB_DENSITY = B.SUB_DENSITY
					WHERE   A.DATA_DATE = B.DATA_DATE
						AND A.RNC_ID = B.RNC_ID
						AND A.CELL_ID = B.CELL_ID');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	END IF;
	
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Update_IMSI_CNT',CONCAT(' Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());
	
END
utf8
utf8_general_ci
latin1_swedish_ci
