CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Sub_Generate_CSV_LTE`(IN GT_DB VARCHAR(100),IN DAILY_DB VARCHAR(100),IN PATH VARCHAR(100),IN PATH2 VARCHAR(100),IN VENDOR_ID TINYINT(4))
BEGIN
       	DECLARE PU_ID INT;
	DECLARE START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE GT_START_TIME VARCHAR(20);
	DECLARE START_DATE VARCHAR(10) DEFAULT CONCAT(LEFT(gt_strtok(GT_DB,3,'_'),4),'-',SUBSTRING(gt_strtok(GT_DB,3,'_'),5,2),'-',SUBSTRING(gt_strtok(GT_DB,3,'_'),7,2));
	DECLARE START_HH VARCHAR(2) DEFAULT LEFT(gt_strtok(GT_DB,4,'_'),2);
	DECLARE START_MM VARCHAR(2) DEFAULT RIGHT(gt_strtok(GT_DB,4,'_'),2);
	DECLARE WORKER_ID VARCHAR(10) DEFAULT CONNECTION_ID();
		
	SET SESSION max_heap_table_size = 1024*1024*1024*4; 
	SET SESSION tmp_table_size = 1024*1024*1024*4; 
	SET SESSION join_buffer_size = 1024*1024*1024; 
	SET SESSION sort_buffer_size = 1024*1024*1024; 
	SET SESSION read_buffer_size = 1024*1024*1024; 
	
        SELECT CONCAT(LEFT(gt_strtok(GT_DB,3,'_'),4),'-',SUBSTRING(gt_strtok(GT_DB,3,'_'),5,2),'-',SUBSTRING(gt_strtok(GT_DB,3,'_'),7,2),' ',LEFT(gt_strtok(GT_DB,4,'_'),2),':',RIGHT(gt_strtok(GT_DB,4,'_'),2),':00') INTO GT_START_TIME;
 	
 	SELECT gt_strtok(GT_DB,2,'_') INTO PU_ID;
 	
 	SET @SqlCmd=CONCAT('SELECT `TECHNOLOGY` INTO @v_TECHNOLOGY FROM `rnc_information` WHERE `RNC`=''',PU_ID,''';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Generate_CSV_LTE','step1 tmp_table_init', NOW());
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS  ',GT_DB,'.`tmp_table_init','_',WORKER_ID,'` ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
		
	SET @TBL_CELL_START='rpt_cell_tile_start';
	
	SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE ',GT_DB,'.`tmp_table_init','_',WORKER_ID,'` ENGINE=MYISAM
				SELECT ENODEB_ID,
					CELL_ID,
					SUM(POS_FIRST_RSRP) AS INIT_RSRP_NUM,
					SUM(POS_FIRST_RSRP_CNT) AS INIT_RSRP_DEN,
					SUM(POS_FIRST_RSRQ) AS INIT_RSRQ_NUM,
					SUM(POS_FIRST_RSRQ_CNT) AS INIT_RSRQ_DEN,
					SUM(SERVING_CNT) AS SERVING_CNT
				FROM ',GT_DB,'.',@TBL_CELL_START,'				
				GROUP BY ENODEB_ID,CELL_ID
				ORDER BY NULL;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Generate_CSV_LTE','step 2 tmp_table_last', NOW());
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS  ',GT_DB,'.`tmp_table_last','_',WORKER_ID,'` ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;	
	
	SET @TBL_CELL_END='rpt_cell_tile_end';
	
	SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE ',GT_DB,'.`tmp_table_last','_',WORKER_ID,'` ENGINE=MYISAM
				SELECT ENODEB_ID,
					CELL_ID,
					SUM(POS_LAST_S_RSRP) AS LAST_RSRP_NUM,
					SUM(POS_LAST_S_RSRP_CNT) AS LAST_RSRP_DEN,
					SUM(POS_LAST_S_RSRQ) AS LAST_RSRQ_NUM,
					SUM(POS_LAST_S_RSRQ_CNT) AS LAST_RSRQ_DEN,
					SUM(CALL_STATUS_2) AS DROP_CALL_CNT,
					SUM(CALL_STATUS_3) AS BLOCKED_CALL_CNT,
					SUM(SERVING_CNT) AS CALL_DENSITY
				FROM ',GT_DB,'.',@TBL_CELL_END,'
				GROUP BY ENODEB_ID,CELL_ID
				ORDER BY NULL;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Generate_CSV_LTE','step 3 tmp_table_pos', NOW());
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS  ',GT_DB,'.`tmp_table_pos','_',WORKER_ID,'` ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @TBL_CELL_POSITION='rpt_cell_tile_position' ;
	
	SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE ',GT_DB,'.`tmp_table_pos','_',WORKER_ID,'` ENGINE=MYISAM
				SELECT ENODEB_ID
					,CELL_ID
					,SUM(HO_4G_X2_INTRA_ATT_CNT+
						HO_4G_S1_INTRA_ATT_CNT+
						HO_4G_X2_INTER_ATT_CNT+
						HO_4G_S1_INTER_ATT_CNT) AS IRAT_HO_ATT_4G_TO_4G_CNT
					,SUM(IRAT_HO_3G_ATT_CNT) AS IRAT_HO_ATT_4G_TO_3G_CNT
					,SUM(MR_4G_RSRP_SERVING_SUM) AS ALL_RSRP_NUM
					,SUM(MR_4G_RSRP_SERVING_CNT) AS ALL_RSRP_DEN
					,SUM(MR_4G_RSRQ_SERVING_SUM) AS ALL_RSRQ_NUM
					,SUM(MR_4G_RSRQ_SERVING_CNT) AS ALL_RSRQ_DEN
				FROM ',GT_DB,'.',@TBL_CELL_POSITION,'
				WHERE CELL_ID IS NOT NULL			
				GROUP BY ENODEB_ID,CELL_ID
				ORDER BY NULL;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Generate_CSV_LTE','step 4 tmp_huawei_csv_lte', NOW());
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS  ',GT_DB,'.`tmp_huawei_csv_lte','_',WORKER_ID,'` ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE ',GT_DB,'.`tmp_huawei_csv_lte','_',WORKER_ID,'`
				(
					ENODEB_ID MEDIUMINT(9) DEFAULT NULL,
					CELL_ID MEDIUMINT(9) DEFAULT NULL,
					`TIMESTAMP` BIGINT(20) DEFAULT NULL,
					INIT_RSRP_NUM 	DOUBLE  DEFAULT NULL,
					INIT_RSRP_DEN	INT  DEFAULT NULL,
					ALL_RSRP_NUM 	DOUBLE  DEFAULT NULL,
					ALL_RSRP_DEN	INT  DEFAULT NULL,
					LAST_RSRP_NUM 	DOUBLE  DEFAULT NULL,
					LAST_RSRP_DEN	INT  DEFAULT NULL,
					INIT_RSRQ_NUM 	DOUBLE  DEFAULT NULL,
					INIT_RSRQ_DEN	INT  DEFAULT NULL,
					ALL_RSRQ_NUM 	DOUBLE  DEFAULT NULL,
					ALL_RSRQ_DEN	INT  DEFAULT NULL,
					LAST_RSRQ_NUM 	DOUBLE  DEFAULT NULL,
					LAST_RSRQ_DEN	INT  DEFAULT NULL,
					CALL_DENSITY	INT  DEFAULT NULL,
					BLOCKED_CALL_CNT INT  DEFAULT NULL,
					DROP_CALL_CNT	INT  DEFAULT NULL,
					IRAT_HO_ATT_4G_TO_3G_CNT INT  DEFAULT NULL,
					IRAT_HO_ATT_4G_TO_4G_CNT INT  DEFAULT NULL
				) ENGINE=MYISAM DEFAULT CHARSET=LATIN1;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('INSERT INTO ',GT_DB,'.`tmp_huawei_csv_lte','_',WORKER_ID,'` 
				( ENODEB_ID,CELL_ID,`TIMESTAMP`)
				SELECT ENODEB_ID,CELL_ID,UNIX_TIMESTAMP(''',GT_START_TIME,''')
				FROM 
				(
					SELECT ENODEB_ID,CELL_ID FROM ',GT_DB,'.`tmp_table_init','_',WORKER_ID,'`
					UNION 
					SELECT ENODEB_ID,CELL_ID FROM ',GT_DB,'.`tmp_table_last','_',WORKER_ID,'`
					UNION 
					SELECT ENODEB_ID,CELL_ID FROM ',GT_DB,'.`tmp_table_pos','_',WORKER_ID,'`
				) AA;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Generate_CSV_LTE','step 5 upd tmp_table_init', NOW());
	
	SET @SqlCmd=CONCAT('UPDATE ',GT_DB,'.`tmp_huawei_csv_lte','_',WORKER_ID,'` a,',GT_DB,'.`tmp_table_init','_',WORKER_ID,'` B
				SET A.INIT_RSRP_NUM=B.INIT_RSRP_NUM
					,A.INIT_RSRP_DEN=B.INIT_RSRP_DEN
					,A.INIT_RSRQ_NUM=B.INIT_RSRQ_NUM
					,A.INIT_RSRQ_DEN=B.INIT_RSRQ_DEN
				WHERE A.ENODEB_ID=B.ENODEB_ID AND A.CELL_ID=B.CELL_ID;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Generate_CSV_LTE','step 6 upd tmp_table_last', NOW());
	
	SET @SqlCmd=CONCAT('UPDATE ',GT_DB,'.`tmp_huawei_csv_lte','_',WORKER_ID,'` a,',GT_DB,'.`tmp_table_last','_',WORKER_ID,'` B
				SET A.LAST_RSRP_NUM=B.LAST_RSRP_NUM
					,A.LAST_RSRP_DEN=B.LAST_RSRP_DEN
					,A.LAST_RSRQ_NUM=B.LAST_RSRQ_NUM
					,A.LAST_RSRQ_DEN=B.LAST_RSRQ_DEN
					,A.CALL_DENSITY=B.CALL_DENSITY
					,A.BLOCKED_CALL_CNT=B.BLOCKED_CALL_CNT
					,A.DROP_CALL_CNT=B.DROP_CALL_CNT
				WHERE A.ENODEB_ID=B.ENODEB_ID AND A.CELL_ID=B.CELL_ID;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Generate_CSV_LTE','step 7 upd tmp_table_pos', NOW());
	SET @SqlCmd=CONCAT('UPDATE ',GT_DB,'.`tmp_huawei_csv_lte','_',WORKER_ID,'` a,',GT_DB,'.`tmp_table_pos','_',WORKER_ID,'` B
				SET A.ALL_RSRP_NUM=B.ALL_RSRP_NUM
					,A.ALL_RSRP_DEN=B.ALL_RSRP_DEN
					,A.ALL_RSRQ_NUM=B.ALL_RSRQ_NUM
					,A.ALL_RSRQ_DEN=B.ALL_RSRQ_DEN
					,A.IRAT_HO_ATT_4G_TO_3G_CNT=B.IRAT_HO_ATT_4G_TO_3G_CNT
					,A.IRAT_HO_ATT_4G_TO_4G_CNT=B.IRAT_HO_ATT_4G_TO_4G_CNT
				WHERE A.ENODEB_ID=B.ENODEB_ID AND A.CELL_ID=B.CELL_ID;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Sub_Generate_CSV_LTE','step 8 output csv', NOW());
	
	SET @SqlCmd=CONCAT('SELECT ''Sector Id'',''`TIMESTAMP`'',''INIT_RSRP_NUM'',''INIT_RSRP_DEN'',''ALL_RSRP_NUM'',''ALL_RSRP_DEN'',''LAST_RSRP_NUM'',''LAST_RSRP_DEN'',''INIT_RSRQ_NUM'',''INIT_RSRQ_DEN'',''ALL_RSRQ_NUM'',''ALL_RSRQ_DEN'',''LAST_RSRQ_NUM'',''LAST_RSRQ_DEN'',''CALL_DENSITY'',''BLOCKED_CALL_CNT'',''DROP_CALL_CNT'',''IRAT_HO_ATT_4G_TO_3G_CNT'',''IRAT_HO_ATT_4G_TO_4G_CNT''
			    UNION 
			    SELECT CONCAT(`CELL_ID`,''@'',`ENODEB_ID`) AS `Sector Id`,
				`TIMESTAMP`,
				IFNULL(`INIT_RSRP_NUM`,''NULL''),
				IFNULL(`INIT_RSRP_DEN`,''NULL''),
				IFNULL(`ALL_RSRP_NUM`,''NULL''),
				IFNULL(`ALL_RSRP_DEN`,''NULL''),
				IFNULL(`LAST_RSRP_NUM`,''NULL''),
				IFNULL(`LAST_RSRP_DEN`,''NULL''),
				IFNULL(`INIT_RSRQ_NUM`,''NULL''),
				IFNULL(`INIT_RSRQ_DEN`,''NULL''),
				IFNULL(`ALL_RSRQ_NUM`,''NULL''),
				IFNULL(`ALL_RSRQ_DEN`,''NULL''),
				IFNULL(`LAST_RSRQ_NUM`,''NULL''),
				IFNULL(`LAST_RSRQ_DEN`,''NULL''),
				IFNULL(`CALL_DENSITY`,''NULL''),
				IFNULL(`BLOCKED_CALL_CNT`,''NULL''),
				IFNULL(`DROP_CALL_CNT`,''NULL''),
				IFNULL(`IRAT_HO_ATT_4G_TO_3G_CNT`,''NULL''),
				IFNULL(`IRAT_HO_ATT_4G_TO_4G_CNT`,''NULL'')
			    FROM ',GT_DB,'.`tmp_huawei_csv_lte','_',WORKER_ID,'`
			    INTO OUTFILE ''',PATH,'/',CASE VENDOR_ID 
					WHEN 1 THEN 'Ericsson'
					WHEN 2 THEN 'Huawei'
					WHEN 3 THEN 'Huawei'
					WHEN 7 THEN 'NSN'
				 END 
				,'-',PU_ID,'-',@v_TECHNOLOGY,'-'
				,'-',START_DATE,'-',START_HH,'-'
				,CASE START_MM 
					WHEN '00' THEN '1'
					WHEN '15' THEN '2'
					WHEN '30' THEN '3'
					WHEN '45' THEN '4'
				 END 
				,'.csv.tmp''
			    FIELDS TERMINATED BY '',''
			    LINES TERMINATED BY ''\\n''
			    ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE ',GT_DB,'.`tmp_table_init','_',WORKER_ID,'` ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE ',GT_DB,'.`tmp_table_last','_',WORKER_ID,'` ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;	
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE ',GT_DB,'.`tmp_table_pos','_',WORKER_ID,'` ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;		
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE ',GT_DB,'.`tmp_huawei_csv_lte','_',WORKER_ID,'` ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Sub_Generate_CSV_LTE',CONCAT('Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());	
	
        SET SESSION max_heap_table_size = 1024*1024*128; 
        SET SESSION tmp_table_size = 1024*1024*128; 
        SET SESSION join_buffer_size = 1024*1024*128; 
        SET SESSION sort_buffer_size = 1024*1024*128; 
        SET SESSION read_buffer_size = 1024*1024*128; 
