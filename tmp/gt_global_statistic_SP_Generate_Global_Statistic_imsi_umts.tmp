CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Generate_Global_Statistic_imsi_umts`(IN DATA_DATE DATE,IN DATA_HOUR TINYINT(2),IN PU_ID MEDIUMINT(9),IN TECH_MASK TINYINT(2), IN GT_DB VARCHAR(100),IN IMSI_CELL TINYINT(2))
BEGIN
	DECLARE SP_Process VARCHAR(100) DEFAULT NULL;
	DECLARE WORKER_ID VARCHAR(10) DEFAULT CONNECTION_ID();
	DECLARE Spider_SP_ERROR CONDITION FOR SQLSTATE '99998';
	DECLARE KPI_ERROR CONDITION FOR SQLSTATE '99999' ;
	DECLARE ZOOM_LEVEL INT;
	SET @FLAG_IMSI_HR=0;
	SET @FLAG_IMSI_DY=0;
	SET @FLAG_MAKE_HR=0;
	SET @FLAG_MAKE_DY=0;
	INSERT INTO gt_gw_main.sp_log VALUES('gt_gw_main','SP_Generate_Global_Statistic_imsi_umts',CONCAT(GT_DB,' CREATE TEMPORARY TABLE tmp_materialization_imsi_umts_',WORKER_ID), NOW());	
	
	SET SESSION group_concat_max_len=102400; 
	
	SET @SqlCmd=CONCAT('SELECT att_value INTO @SYS_CONFIG_TILE FROM gt_covmo.`sys_config`
							WHERE group_name=''system'' AND att_name=''MapResolution'';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
	IF gt_covmo_csv_count(@SYS_CONFIG_TILE,',') =3 THEN
		
		SET @SqlCmd=CONCAT('SELECT gt_covmo_csv_get(att_value,3) INTO @ZOOM_LEVEL FROM gt_covmo.`sys_config` WHERE `group_name`=''system'' AND att_name = ''MapResolution'';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	ELSE 
		SET @SqlCmd=CONCAT('SELECT att_value INTO @ZOOM_LEVEL FROM gt_global_statistic.`nw_config` WHERE `group_name`=''system'' AND att_name = ''MapResolution'';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	END IF;
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS ',GT_DB,'.tmp_materialization_imsi_umts_',WORKER_ID,';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE ',GT_DB,'.tmp_materialization_imsi_umts_',WORKER_ID,' 
				(
					`IMSI` VARCHAR(20) NOT NULL,
					`DATA_DATE` DATETIME NOT NULL,
					`DATA_HOUR` TINYINT(2) NOT NULL,
					`CALL_CNT` INT(11) DEFAULT NULL,
					`VOICE_MO_CNT` INT(11) DEFAULT NULL,
					`VOICE_MT_CNT` INT(11) DEFAULT NULL,
					`VIDEO_MO_CNT` INT(11) DEFAULT NULL,
					`VIDEO_MT_CNT` INT(11) DEFAULT NULL,
					`R99_MO_CNT` INT(11) DEFAULT NULL,
					`R99_MT_CNT` INT(11) DEFAULT NULL,
					`HSPA_MO_CNT` INT(11) DEFAULT NULL,
					`HSPA_MT_CNT` INT(11) DEFAULT NULL,
					`MRAB_MO_CNT` INT(11) DEFAULT NULL,
					`MRAB_MT_CNT` INT(11) DEFAULT NULL,
					`SIGNAL_MO_CNT` INT(11) DEFAULT NULL,
					`SIGNAL_MT_CNT` INT(11) DEFAULT NULL,
					`SMS_MO_CNT` INT(11) DEFAULT NULL,
					`SMS_MT_CNT` INT(11) DEFAULT NULL,
					`PS_OTHER_CNT` INT(11) DEFAULT NULL,
					`CALL_DUR_SUM` DOUBLE DEFAULT NULL,
					`VOICE_DUR_SUM` DOUBLE DEFAULT NULL,
					`VIDEO_DUR_SUM` DOUBLE DEFAULT NULL,
					`R99_DUR_SUM` DOUBLE DEFAULT NULL,
					`HSPA_DUR_SUM` DOUBLE DEFAULT NULL,
					`MRAB_DUR_SUM` DOUBLE DEFAULT NULL,
					`DROP_CNT` INT(11) DEFAULT NULL,
					`DROP_VOICE_CNT` INT(11) DEFAULT NULL,
					`DROP_VEDIO_CNT` INT(11) DEFAULT NULL,
					`DROP_R99_CNT` INT(11) DEFAULT NULL,
					`DROP_HSPA_CNT` INT(11) DEFAULT NULL,
					`DROP_MRAB_CNT` INT(11) DEFAULT NULL,
					`DROP_SMS_CNT` INT(11) DEFAULT NULL,
					`DROP_SIGNAL_CNT` INT(11) DEFAULT NULL,
					`DROP_PS_OTHER_CNT` INT(11) DEFAULT NULL,
					`DROP_RF_CNT` INT(11) DEFAULT NULL,
					`DROP_CONG_CNT` INT(11) DEFAULT NULL,
					`DROP_TRANS_CNT` INT(11) DEFAULT NULL,
					`DROP_SHO_CNT` INT(11) DEFAULT NULL,
					`DROP_HHO_CNT` INT(11) DEFAULT NULL,
					`DROP_IRAT_CNT` INT(11) DEFAULT NULL,
					`BLOCK_CNT` INT(11) DEFAULT NULL,
					`BLOCK_VOICE_CNT` INT(11) DEFAULT NULL,
					`BLOCK_VEDIO_CNT` INT(11) DEFAULT NULL,
					`BLOCK_R99_CNT` INT(11) DEFAULT NULL,
					`BLOCK_HSPA_CNT` INT(11) DEFAULT NULL,
					`BLOCK_MRAB_CNT` INT(11) DEFAULT NULL,
					`BLOCK_SMS_CNT` INT(11) DEFAULT NULL,
					`BLOCK_SMS_MT_CNT` int(11) DEFAULT NULL,
					`BLOCK_SMS_MO_CNT` int(11) DEFAULT NULL,
					`BLOCK_SIGNAL_CNT` INT(11) DEFAULT NULL,
					`BLOCK_PS_OTHER_CNT` INT(11) DEFAULT NULL,
					`SHO_ATTEMPT_CNT` INT(11) DEFAULT NULL,
					`SHO_FAILURE_CNT` INT(11) DEFAULT NULL,
					`HHO_ATTEMPT_CNT` INT(11) DEFAULT NULL,
					`HHO_FAILURE_CNT` INT(11) DEFAULT NULL,
					`IRAT_ATTEMPT_CNT` INT(11) DEFAULT NULL,
					`IRAT_FAILURE_CNT` INT(11) DEFAULT NULL,
					`MOVING_CALL_CNT` INT(11) DEFAULT NULL,
					`INDOOR_CALL_CNT` INT(11) DEFAULT NULL,
					`PS_UL_VOLUME_SUM` DOUBLE DEFAULT NULL,
					`PS_DL_VOLUME_SUM` DOUBLE DEFAULT NULL,
					`PS_UL_SPEED_MAX` DOUBLE DEFAULT NULL,
					`PS_DL_SPEED_MAX` DOUBLE DEFAULT NULL,
					`FIRST_RSCP_SUM` DOUBLE DEFAULT NULL,
					`FIRST_RSCP_CNT` INT(11) DEFAULT NULL,
					`FIRST_ECNO_SUM` DOUBLE DEFAULT NULL,
					`FIRST_ECNO_CNT` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SUM` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_CNT` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VOICE_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VOICE_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VEDIO_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VEDIO_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_R99_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_R99_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_HSPA_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_HSPA_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_MRAB_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_MRAB_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SIG_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SIG_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_OTH_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_OTH_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SMS_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SMS_CNT` int(11) DEFAULT NULL,
					`SF_CNT` INT(11) DEFAULT NULL,
					`SF_VOICE_CNT` INT(11) DEFAULT NULL,
					`SF_VEDIO_CNT` INT(11) DEFAULT NULL,
					`SF_R99_CNT` INT(11) DEFAULT NULL,
					`SF_HSPA_CNT` INT(11) DEFAULT NULL,
					`SF_MRAB_CNT` INT(11) DEFAULT NULL,
					`SF_SMS_CNT` INT(11) DEFAULT NULL,
					`SF_SMS_MT_CNT` int(11) DEFAULT NULL,
					`SF_SMS_MO_CNT` int(11) DEFAULT NULL,
					`SF_SIGNAL_CNT` INT(11) DEFAULT NULL,
					`SF_PS_OTHER_CNT` INT(11) DEFAULT NULL,
					`PDP_ACTIVATION_REQUEST` INT(11) DEFAULT NULL,
					`PDP_ACTIVATION_ACCEPT` INT(11) DEFAULT NULL,
					`PDP_DEACTIVATION_REQUEST` INT(11) DEFAULT NULL,
					`PDP_DEACTIVATION_ACCEPT` INT(11) DEFAULT NULL,
					`AUTH_REQUEST` INT(11) DEFAULT NULL,
					`AUTH_RESPONSE` INT(11) DEFAULT NULL,
					`AUTH_CIPH_REQUEST` INT(11) DEFAULT NULL,
					`AUTH_CIPH_RESPONSE` INT(11) DEFAULT NULL,
					`SECURITY_MODE_ATT` INT(11) DEFAULT NULL,
					`SECURITY_MODE_SUCCESS` INT(11) DEFAULT NULL,
					`LU_REQUEST` INT(11) DEFAULT NULL,
					`LU_ACCEPT` INT(11) DEFAULT NULL,
					`RAU_REQUEST` INT(11) DEFAULT NULL,
					`RAU_ACCEPT` INT(11) DEFAULT NULL,
					`MAKE_ID` INT(11) DEFAULT NULL,
					`MODEL_ID` INT(11) DEFAULT NULL,
					',CASE WHEN IMSI_CELL=1 THEN '
					`START_TILE_ID` BIGINT(20) DEFAULT NULL,
					`END_TILE_ID` BIGINT(20) DEFAULT NULL,
					`START_CELL_ID` MEDIUMINT(9) DEFAULT NULL,
					`START_SITE_ID` VARCHAR(20) DEFAULT NULL,
					`START_REG_1_ID` BIGINT(20) DEFAULT NULL,
					`START_REG_2_ID` BIGINT(20) DEFAULT NULL,
					`START_REG_3_ID` BIGINT(20) DEFAULT NULL,
					`END_CELL_ID` MEDIUMINT(9) DEFAULT NULL,
					`END_SITE_ID` VARCHAR(20) DEFAULT NULL,
					`END_REG_1_ID` BIGINT(20) DEFAULT NULL,
					`END_REG_2_ID` BIGINT(20) DEFAULT NULL,
					`END_REG_3_ID` BIGINT(20) DEFAULT NULL,' ELSE '' END,'
					`MAKE_MODEL` VARCHAR(200) DEFAULT NULL
					) ENGINE=MYISAM DEFAULT CHARSET=latin1 DELAY_KEY_WRITE=1;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES('gt_gw_main','SP_Generate_Global_Statistic_imsi_umts',CONCAT(GT_DB,' INSERT INTO tbl_',GT_DB,'_',WORKER_ID), NOW());	
	 	
	SET @SqlCmd=CONCAT('INSERT INTO ',GT_DB,'.tmp_materialization_imsi_umts_',WORKER_ID,' 
				(	
					`IMSI`,
					`DATA_DATE`,
					`DATA_HOUR`,
					CALL_CNT,
					VOICE_MO_CNT,
					VOICE_MT_CNT,
					VIDEO_MO_CNT,
					VIDEO_MT_CNT,
					R99_MO_CNT,
					R99_MT_CNT,
					HSPA_MO_CNT,
					HSPA_MT_CNT,
					MRAB_MO_CNT,
					MRAB_MT_CNT,
					SIGNAL_MO_CNT,
					SIGNAL_MT_CNT,
					SMS_MO_CNT,
					SMS_MT_CNT,
					PS_OTHER_CNT,
					CALL_DUR_SUM,
					VOICE_DUR_SUM,
					VIDEO_DUR_SUM,
					R99_DUR_SUM,
					HSPA_DUR_SUM,
					MRAB_DUR_SUM,
					DROP_CNT,
					DROP_VOICE_CNT,
					DROP_VEDIO_CNT,
					DROP_R99_CNT,
					DROP_HSPA_CNT,
					DROP_MRAB_CNT,
					DROP_SMS_CNT,
					DROP_SIGNAL_CNT,
					DROP_PS_OTHER_CNT,
					DROP_RF_CNT,
					DROP_CONG_CNT,
					DROP_TRANS_CNT,
					DROP_SHO_CNT,
					DROP_HHO_CNT,
					DROP_IRAT_CNT,
					BLOCK_CNT,
					BLOCK_VOICE_CNT,
					BLOCK_VEDIO_CNT,
					BLOCK_R99_CNT,
					BLOCK_HSPA_CNT,
					BLOCK_MRAB_CNT,
					BLOCK_SMS_CNT,
					BLOCK_SMS_MT_CNT,
					BLOCK_SMS_MO_CNT,
					BLOCK_SIGNAL_CNT,
					BLOCK_PS_OTHER_CNT,
					SHO_ATTEMPT_CNT,
					SHO_FAILURE_CNT,
					HHO_ATTEMPT_CNT,
					HHO_FAILURE_CNT,
					IRAT_ATTEMPT_CNT,
					IRAT_FAILURE_CNT,
					MOVING_CALL_CNT,
					INDOOR_CALL_CNT,
					PS_UL_VOLUME_SUM,
					PS_DL_VOLUME_SUM,
					PS_UL_SPEED_MAX,
					PS_DL_SPEED_MAX,
					FIRST_RSCP_SUM,
					FIRST_RSCP_CNT,
					FIRST_ECNO_SUM,
					FIRST_ECNO_CNT,
					CALL_SETUP_TIME_SUM,
					CALL_SETUP_TIME_CNT,
					CALL_SETUP_TIME_VOICE_SUM,
					CALL_SETUP_TIME_VOICE_CNT,
					CALL_SETUP_TIME_VEDIO_SUM ,
					CALL_SETUP_TIME_VEDIO_CNT,
					CALL_SETUP_TIME_R99_SUM,
					CALL_SETUP_TIME_R99_CNT, 
					CALL_SETUP_TIME_HSPA_SUM, 
					CALL_SETUP_TIME_HSPA_CNT, 
					CALL_SETUP_TIME_MRAB_SUM,
					CALL_SETUP_TIME_MRAB_CNT,
					CALL_SETUP_TIME_SIG_SUM,
					CALL_SETUP_TIME_SIG_CNT, 
					CALL_SETUP_TIME_OTH_SUM,
					CALL_SETUP_TIME_OTH_CNT,
					CALL_SETUP_TIME_SMS_SUM,
					CALL_SETUP_TIME_SMS_CNT, 
					SF_CNT,
					SF_VOICE_CNT,
					SF_VEDIO_CNT,
					SF_R99_CNT,
					SF_HSPA_CNT,
					SF_MRAB_CNT,
					SF_SMS_CNT,
					SF_SMS_MT_CNT,
					SF_SMS_MO_CNT,
					SF_SIGNAL_CNT,
					SF_PS_OTHER_CNT,
					PDP_ACTIVATION_REQUEST,
					PDP_ACTIVATION_ACCEPT,
					PDP_DEACTIVATION_REQUEST,
					PDP_DEACTIVATION_ACCEPT,
					AUTH_REQUEST,
					AUTH_RESPONSE,
					AUTH_CIPH_REQUEST,
					AUTH_CIPH_RESPONSE,
					SECURITY_MODE_ATT,
					SECURITY_MODE_SUCCESS,
					LU_REQUEST,
					LU_ACCEPT,
					RAU_REQUEST,
					RAU_ACCEPT,
					MAKE_ID,
					MODEL_ID
					',CASE WHEN IMSI_CELL=1 THEN ',
					START_TILE_ID,
 					END_TILE_ID,
					START_CELL_ID,
					START_SITE_ID,
					END_CELL_ID,
					END_SITE_ID' ELSE '' END,'
					)
				SELECT
					`IMSI`,
					`DATA_DATE`,
					`DATA_HOUR`,
					COUNT(*) AS `CALL_CNT`,
					SUM(IF(CALL_TYPE=10 AND RRC_REQUEST_TYPE IN (0,1,2,3,4,9,10,11,12,13,14,15,16,21),1,0)) AS VOICE_MO_CNT,
					SUM(IF(CALL_TYPE=10 AND RRC_REQUEST_TYPE IN (5,6,7,8,17,18,19,20),1,0)) AS VOICE_MT_CNT,
					SUM(IF(CALL_TYPE=11 AND RRC_REQUEST_TYPE IN (0,1,2,3,4,9,10,11,12,13,14,15,16,21),1,0)) AS VIDEO_MO_CNT,
					SUM(IF(CALL_TYPE=11 AND RRC_REQUEST_TYPE IN (5,6,7,8,17,18,19,20),1,0)) AS VIDEO_MT_CNT,
					SUM(IF(CALL_TYPE=12 AND RRC_REQUEST_TYPE IN (0,1,2,3,4,9,10,11,12,13,14,15,16,21),1,0)) AS R99_MO_CNT,
					SUM(IF(CALL_TYPE=12 AND RRC_REQUEST_TYPE IN (5,6,7,8,17,18,19,20),1,0)) AS R99_MT_CNT,
					SUM(IF(CALL_TYPE=13 AND RRC_REQUEST_TYPE IN (0,1,2,3,4,9,10,11,12,13,14,15,16,21),1,0)) AS HSPA_MO_CNT,
					SUM(IF(CALL_TYPE=13 AND RRC_REQUEST_TYPE IN (5,6,7,8,17,18,19,20),1,0)) AS HSPA_MT_CNT,
					SUM(IF(CALL_TYPE=14 AND RRC_REQUEST_TYPE IN (0,1,2,3,4,9,10,11,12,13,14,15,16,21),1,0)) AS MRAB_MO_CNT,
					SUM(IF(CALL_TYPE=14 AND RRC_REQUEST_TYPE IN (5,6,7,8,17,18,19,20),1,0)) AS MRAB_MT_CNT,
					SUM(IF(CALL_TYPE=15 AND RRC_REQUEST_TYPE IN (0,1,2,3,4,9,10,11,12,13,14,15,16,21),1,0)) AS SIGNAL_MO_CNT,
					SUM(IF(CALL_TYPE=15 AND RRC_REQUEST_TYPE IN (5,6,7,8,17,18,19,20),1,0)) AS SIGNAL_MT_CNT,
					SUM(IF(CALL_TYPE=16 AND RRC_REQUEST_TYPE IN (0,1,2,3,4,9,10,11,12,13,14,15,16,21),1,0)) AS SMS_MO_CNT,
					SUM(IF(CALL_TYPE=16 AND RRC_REQUEST_TYPE IN (5,6,7,8,17,18,19,20),1,0)) AS SMS_MT_CNT,
					SUM(IF(CALL_TYPE=18,1,0)) AS PS_OTHER_CNT,
					SUM(RRC_CONNECT_DURATION) AS CALL_DUR_SUM,
					SUM(IF(CALL_TYPE=10,RRC_CONNECT_DURATION,0)) AS VOICE_DUR_SUM,
					SUM(IF(CALL_TYPE=11,RRC_CONNECT_DURATION,0)) AS VIDEO_DUR_SUM,
					SUM(IF(CALL_TYPE=12,RRC_CONNECT_DURATION,0)) AS R99_DUR_SUM,
					SUM(IF(CALL_TYPE=13,RRC_CONNECT_DURATION,0)) AS HSPA_DUR_SUM,
					SUM(IF(CALL_TYPE=14,RRC_CONNECT_DURATION,0)) AS MRAB_DUR_SUM,
					SUM(IF(CALL_STATUS=2,1,0)) AS DROP_CNT,
					SUM(IF(CALL_STATUS=2 AND CALL_TYPE=10,1,0)) AS DROP_VOICE_CNT,
					SUM(IF(CALL_STATUS=2 AND CALL_TYPE=11,1,0)) AS DROP_VEDIO_CNT,
					SUM(IF(CALL_STATUS=2 AND CALL_TYPE=12,1,0)) AS DROP_R99_CNT,
					SUM(IF(CALL_STATUS=2 AND CALL_TYPE=13,1,0)) AS DROP_HSPA_CNT,
					SUM(IF(CALL_STATUS=2 AND CALL_TYPE=14,1,0)) AS DROP_MRAB_CNT,
					SUM(IF(CALL_STATUS=2 AND CALL_TYPE=16,1,0)) AS DROP_SMS_CNT,
					SUM(IF(CALL_STATUS=2 AND CALL_TYPE=15,1,0)) AS DROP_SIGNAL_CNT,
					SUM(IF(CALL_STATUS=2 AND CALL_TYPE=18,1,0)) AS DROP_PS_OTHER_CNT,
					SUM(IF(VENDOR_DROP_CAUSE IN (100,101,102,103,104),1,0)) AS DROP_RF_CNT,
					SUM(IF(VENDOR_DROP_CAUSE IN (201),1,0)) AS DROP_CONG_CNT,
					SUM(IF(VENDOR_DROP_CAUSE IN (300, 301, 302, 303),1,0)) AS DROP_TRANS_CNT,
					SUM(IF(VENDOR_DROP_CAUSE IN (600,601,602,603,604,605,606),1,0)) AS DROP_SHO_CNT,
					SUM(IF(VENDOR_DROP_CAUSE IN (1001,1101,1102),1,0)) AS DROP_HHO_CNT,
					SUM(IF(VENDOR_DROP_CAUSE IN (701,702),1,0)) AS DROP_IRAT_CNT,
					SUM(IF(CALL_STATUS=3,1,0)) AS BLOCK_CNT,
					SUM(IF(CALL_STATUS=3 AND CALL_TYPE=10,1,0)) AS BLOCK_VOICE_CNT,
					SUM(IF(CALL_STATUS=3 AND CALL_TYPE=11,1,0)) AS BLOCK_VEDIO_CNT,
					SUM(IF(CALL_STATUS=3 AND CALL_TYPE=12,1,0)) AS BLOCK_R99_CNT,
					SUM(IF(CALL_STATUS=3 AND CALL_TYPE=13,1,0)) AS BLOCK_HSPA_CNT,
					SUM(IF(CALL_STATUS=3 AND CALL_TYPE=14,1,0)) AS BLOCK_MRAB_CNT,
					SUM(IF(CALL_STATUS=3 AND CALL_TYPE=16,1,0)) AS BLOCK_SMS_CNT,
					SUM(IF(CALL_TYPE=16 AND RRC_REQUEST_TYPE IN (5,6,7,8,17,18,19,20),1,0))  AS SMS_MT_CNT,
					SUM(IF(CALL_TYPE=16 AND RRC_REQUEST_TYPE IN (0,1,2,3,4,9,10,11,12,13,14,15,16,21),1,0))  AS SMS_MO_CNT,
					SUM(IF(CALL_STATUS=3 AND CALL_TYPE=15,1,0)) AS BLOCK_SIGNAL_CNT,
					SUM(IF(CALL_STATUS=3 AND CALL_TYPE=18,1,0)) AS BLOCK_PS_OTHER_CNT,
					SUM(SHO) AS SHO_ATTEMPT_CNT,
					SUM(SHO_FAILURE) AS SHO_FAILURE_CNT,
					IFNULL(SUM(IFHO),0) AS HHO_ATTEMPT_CNT,
					IFNULL(SUM(IFHO_FAILURE),0) AS HHO_FAILURE_CNT,
					IFNULL(SUM(IRAT_HHO_ATTEMPT),0) AS IRAT_ATTEMPT_CNT,
					IFNULL(SUM(IRAT_HHO_ATTEMPT-`IRAT_HHO_SUCCESS`),0) AS IRAT_FAILURE_CNT,
					SUM(IF(INDOOR=0 AND MOVING=1,1,0)) AS MOVING_CALL_CNT,
					SUM(IF(INDOOR=1,1,0)) AS INDOOR_CALL_CNT,
					IFNULL(SUM(IF(CALL_TYPE IN (12,13,14,18),UL_TRAFFIC_VOLUME,0)),0) AS PS_UL_VOLUME_SUM,
					IFNULL(SUM(IF(CALL_TYPE IN (12,13,14,18),DL_TRAFFIC_VOLUME,0)),0) AS PS_DL_VOLUME_SUM,
					MAX(IF(CALL_TYPE IN (12,13,14,18),UL_THROUGHPUT_AVG,0)) AS PS_UL_SPEED_MAX,
					MAX(IF(CALL_TYPE IN (12,13,14,18),DL_THROUGHPUT_AVG,0)) AS PS_DL_SPEED_MAX,
					SUM(POS_FIRST_RSCP) AS FIRST_RSCP_SUM,
					COUNT(POS_FIRST_RSCP) AS FIRST_RSCP_CNT,
					SUM(POS_FIRST_ECN0) AS FIRST_ECNO_SUM,
					COUNT(POS_FIRST_ECN0) AS FIRST_ECNO_CNT,
					SUM(CALL_SETUP_TIME) AS CALL_SETUP_TIME_SUM,
					SUM(IF(CALL_SETUP_TIME>=0,1,0)) AS CALL_SETUP_TIME_CNT,
	
					IFNULL(SUM(IF(CALL_TYPE =10,CALL_SETUP_TIME,0)),0) AS CALL_SETUP_TIME_VOICE_SUM,
					IFNULL(SUM(IF(CALL_SETUP_TIME>=0 AND CALL_TYPE =10,1,0)),0) AS CALL_SETUP_TIME_VOICE_CNT,
					IFNULL(SUM(IF(CALL_TYPE =11,CALL_SETUP_TIME,0)),0) AS CALL_SETUP_TIME_VEDIO_SUM,
					IFNULL(SUM(IF(CALL_SETUP_TIME>=0 AND CALL_TYPE =11,1,0)),0) AS CALL_SETUP_TIME_VEDIO_CNT,
					IFNULL(SUM(IF(CALL_TYPE =12,CALL_SETUP_TIME,0)),0) AS CALL_SETUP_TIME_R99_SUM,
					IFNULL(SUM(IF(CALL_SETUP_TIME>=0 AND CALL_TYPE =12,1,0)),0) AS CALL_SETUP_TIME_R99_CNT,
					IFNULL(SUM(IF(CALL_TYPE =13,CALL_SETUP_TIME,0)),0) AS CALL_SETUP_TIME_HSPA_SUM,
					IFNULL(SUM(IF(CALL_SETUP_TIME>=0 AND CALL_TYPE =13,1,0)),0) AS CALL_SETUP_TIME_HSPA_CNT,
					IFNULL(SUM(IF(CALL_TYPE =14,CALL_SETUP_TIME,0)),0) AS CALL_SETUP_TIME_MRAB_SUM,
					IFNULL(SUM(IF(CALL_SETUP_TIME>=0 AND CALL_TYPE =14,1,0)),0) AS CALL_SETUP_TIME_MRAB_CNT,
					IFNULL(SUM(IF(CALL_TYPE =15,CALL_SETUP_TIME,0)),0) AS CALL_SETUP_TIME_SIG_SUM,
					IFNULL(SUM(IF(CALL_SETUP_TIME>=0 AND CALL_TYPE =15,1,0)),0) AS CALL_SETUP_TIME_SIG_CNT,
					IFNULL(SUM(IF(CALL_TYPE =18,CALL_SETUP_TIME,0)),0) AS CALL_SETUP_TIME_OTH_SUM,
					IFNULL(SUM(IF(CALL_SETUP_TIME>=0 AND CALL_TYPE =18,1,0)),0) AS CALL_SETUP_TIME_OTH_CNT,
					IFNULL(SUM(IF(CALL_TYPE =16,CALL_SETUP_TIME,0)),0) AS CALL_SETUP_TIME_SMS_SUM,
					IFNULL(SUM(IF(CALL_SETUP_TIME>=0 AND CALL_TYPE =16,1,0)),0) AS CALL_SETUP_TIME_SMS_CNT,
	
					SUM(IF(CALL_STATUS=6 ,1,0)) AS SF_CNT,
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=10,1,0)) AS SF_VOICE_CNT,
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=11,1,0)) AS SF_VEDIO_CNT,
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=12,1,0)) AS SF_R99_CNT,
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=13,1,0)) AS SF_HSPA_CNT,
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=14,1,0)) AS SF_MRAB_CNT,
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=16,1,0)) AS SF_SMS_CNT,
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=16,1,0)) AS SF_SMS_MT_CNT,
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=16,1,0)) AS SF_SMS_MO_CNT,	
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=15,1,0)) AS SF_SIGNAL_CNT,
					SUM(IF(CALL_STATUS=6 AND CALL_TYPE=18,1,0)) AS SF_PS_OTHER_CNT,
 					IFNULL(SUM(PDP_ACTIVATION_REQUEST),0) AS PDP_ACTIVATION_REQUEST,
					IFNULL(SUM(PDP_ACTIVATION_ACCEPT),0) AS PDP_ACTIVATION_ACCEPT,
					IFNULL(SUM(PDP_DEACTIVATION_REQUEST),0) AS PDP_DEACTIVATION_REQUEST,
					IFNULL(SUM(PDP_DEACTIVATION_ACCEPT),0) AS PDP_DEACTIVATION_ACCEPT,
					IFNULL(SUM(AUTH_REQUEST),0) AS AUTH_REQUEST,
					IFNULL(SUM(AUTH_RESPONSE),0) AS AUTH_RESPONSE,
					IFNULL(SUM(AUTH_CIPH_REQUEST),0) AS AUTH_CIPH_REQUEST,
					IFNULL(SUM(AUTH_CIPH_RESPONSE),0) AS AUTH_CIPH_RESPONSE,
					IFNULL(SUM(SECURITY_MODE_ATT),0) AS SECURITY_MODE_ATT,
					IFNULL(SUM(SECURITY_MODE_SUCCESS),0) AS SECURITY_MODE_SUCCESS,
					IFNULL(SUM(LU_REQUEST),0) AS LU_REQUEST,
					IFNULL(SUM(LU_ACCEPT),0) AS LU_ACCEPT,
					IFNULL(SUM(RAU_REQUEST),0) AS RAU_REQUEST,
					IFNULL(SUM(RAU_ACCEPT),0) AS RAU_ACCEPT,
					`MAKE_ID`,
					`MODEL_ID`
					',CASE WHEN IMSI_CELL=1 THEN CONCAT(',
					gt_covmo_proj_geohash_to_hex_geohash(POS_FIRST_LOC,',@ZOOM_LEVEL,') AS START_TILE_ID,
 					gt_covmo_proj_geohash_to_hex_geohash(POS_LAST_LOC,',@ZOOM_LEVEL,') AS END_TILE_ID, 					
					POS_FIRST_CELL AS `START_CELL_ID`,
					POS_FIRST_SITE AS `START_SITE_ID`,
					POS_LAST_CELL AS `END_CELL_ID`,
					POS_LAST_SITE AS `END_SITE_ID`') ELSE '' END,'					
					FROM ',GT_DB,'.table_call
					WHERE DATA_HOUR =',DATA_HOUR,' AND IMSI IS NOT NULL AND IMSI<>''0''
					GROUP BY IMSI
					ORDER BY NULL;
				');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('SELECT * FROM ',GT_DB,'.tmp_materialization_imsi_umts_',WORKER_ID,';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS ',GT_DB,'.tmp_materialization_imsi_umts_',WORKER_ID,';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	INSERT INTO gt_gw_main.sp_log VALUES('gt_gw_main','SP_Generate_Global_Statistic_imsi_umts',CONCAT(GT_DB,' END'), NOW());
	
    END
utf8
utf8_general_ci
latin1_swedish_ci
