CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Generate_Report_Optimization_LTE`(IN gt_db VARCHAR(100),IN GT_COVMO VARCHAR(100))
BEGIN	
	DECLARE START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE SH_EH VARCHAR(9) DEFAULT RIGHT(GT_DB,9);
	DECLARE CURRENT_NT_DB VARCHAR(50) DEFAULT CONCAT('gt_nt_',gt_strtok(GT_DB,3,'_'));
	DECLARE PMC_FLAG VARCHAR(10);
	DECLARE IMSI_IMEI_DIFF_FLAG VARCHAR(10);
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Report_Optimization_LTE','Start', START_TIME);	
	SELECT REPLACE(GT_DB,SH_EH,'0000_0000') INTO GT_DB;		
	SELECT LOWER(`value`) INTO PMC_FLAG FROM gt_gw_main.integration_param WHERE gt_group = 'sp' AND gt_name = 'pmc' ;		 
	SELECT LOWER(`value`) INTO IMSI_IMEI_DIFF_FLAG  FROM gt_gw_main.integration_param WHERE gt_group = 'sp' AND gt_name = 'imsi_imei_diff' ;
	CALL GT_GW_MAIN.SP_Sub_Generate_Overshooting_Severity_LTE(GT_DB,GT_COVMO,'DAILY');
	CALL GT_GW_MAIN.SP_Sub_Generate_Overshooting_Severity_LTE(GT_DB,GT_COVMO,'d7');

	IF IMSI_IMEI_DIFF_FLAG = 'true' THEN 
		CALL gt_gw_main.`SP_Generate_IMSI_IMEI_Daily`(GT_DB,4);
	ELSE
		CALL gt_gw_main.SP_Generate_IMSI_PU_Daily(GT_DB,4);
	END IF;	
	
	SET @SqlCmd=CONCAT('UPDATE ',GT_DB,'.opt_nbr_inter_intra_lte_dy A, ',CURRENT_NT_DB,'.nt2_nbr_4_4_lte B 
				SET A.NBR_TYPE = B.NBR_TYPE
				WHERE A.ENODEB_ID = B.ENODEB_ID AND A.CELL_ID = B.CELL_ID AND A.NBR_ENODEB_ID = B.NBR_ENODEB_ID AND A.NBR_CELL_ID = B.NBR_CELL_ID;
				');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
		
	CALL gt_gw_main.SP_Sub_Generate_Pre_NBO_Daily(GT_DB,'opt_nbr_inter_intra_lte','LTE',
		'SUB_REGION_ID|EUTRABAND|EARFCN|ENODEB_ID|CELL_ID|CELL_NAME|NBR_ENODEB_ID|NBR_CELL_ID|NBR_CELL_NAME|NBR_TYPE',
		'DISTANCE_METER|HO_COUNT|PINGPONG_HO_CNT|HO_FAIL_CNT|HO_RE_EST_CNT|TA_HO_SUM|TA_HO_CNT|MEAS_COUNT|RSRP_SUM|RSRQ_SUM|RSRP_CNT|RSRQ_CNT|BEST_MEAS_CNT|SERVING_RSRP_SUM|SERVING_RSRQ_SUM|SERVING_RSRP_CNT|SERVING_RSRQ_CNT|HO_INTERRUP_TIME|HO_INTERRUP_CNT',
		'DATA_DATE');
	
	CALL gt_gw_main.SP_Sub_Generate_Pre_NBO_Daily(GT_DB,'opt_nbr_irat3g_lte','LTE',
		'SUB_REGION_ID|EUTRABAND|EARFCN|ENODEB_ID|CELL_ID|CELL_NAME|NBR_RNC_ID|NBR_CELL_ID|NBR_CELL_NAME',
		'DISTANCE_METER|SERVING_TA_SUM|SERVING_TA_CNT|SERVING_RSRP_SUM|SERVING_RSRQ_SUM|SERVING_RSRP_CNT|SERVING_RSRQ_CNT|HO_CNT|HO_FAIL_CNT|MEAS_CNT|MEAS_RSCP_SUM|MEAS_ECN0_SUM',
		'DATA_DATE');
	
	CALL gt_gw_main.SP_Sub_Generate_Pre_NBO_Daily(GT_DB,'opt_cf_pre_agg_report_lte','LTE',
		'ENODEB_ID|CELL_ID|POS_MR_ANGLE|AZIMUTH|CAL_AZIMUTH|CAL_POS_MR_ANGLE',
		'MR_COUNT|RSRP_DIFF_SUM|RSRP_CAL_CNT|PCI_COUNT',
		'DATA_DATE|DATA_HOUR');
	

	IF PMC_FLAG = 'true' THEN 
		CALL gt_gw_main.SP_Sub_Gen_CELL_PMC_RPT(gt_db,gt_db,'DAILY');
	END IF;
		
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Report_Optimization_LTE',CONCAT('Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());		
