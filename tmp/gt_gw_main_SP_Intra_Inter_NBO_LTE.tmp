CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Intra_Inter_NBO_LTE`(IN GT_DB VARCHAR(50))
BEGIN
	DECLARE START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE WORKER_ID VARCHAR(10) DEFAULT CONNECTION_ID();
	DECLARE CURRENT_NT_DB VARCHAR(50) DEFAULT CONCAT('gt_nt_',gt_strtok(GT_DB,3,'_'));
	SET SESSION max_heap_table_size = 1024*1024*1024*4; 
	SET SESSION tmp_table_size = 1024*1024*1024*4; 
	SET @SqlCmd=CONCAT('SELECT `att_value` INTO @PING_PONG_TRIGGER_TIME FROM ',GT_DB,'.`sys_config` WHERE `group_name`=''ping_pong'' AND att_name = ''ping_pong_trigger_time'';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @PING_PONG_TRIGGER_TIME = @PING_PONG_TRIGGER_TIME * 1000;
	
  	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Intra_Inter_NBO_LTE','START', START_TIME);
 
	SET @SqlCmd=CONCAT('DROP TABLE IF EXISTS ',GT_DB,'.tmp_nbo_table_',WORKER_ID,';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('CREATE TABLE ',GT_DB,'.`tmp_nbo_table_',WORKER_ID,'` (
				ENODEB_ID MEDIUMINT(9) DEFAULT NULL,
				CELL_ID MEDIUMINT(9) DEFAULT NULL,
				NBR_ENODEB_ID MEDIUMINT(9) DEFAULT NULL,
				NBR_CELL_ID MEDIUMINT(9) DEFAULT NULL,
				CALL_ID BIGINT(20) DEFAULT NULL,
				SEQ_ID INT(20) DEFAULT NULL,
				DATA_HOUR TINYINT(4) DEFAULT NULL,
				HO_COUNT MEDIUMINT(9) DEFAULT ''0'',
				PINGPONG_HO_CNT MEDIUMINT(9) DEFAULT ''0'',
				HO_FAIL_CNT MEDIUMINT(9) DEFAULT ''0'',
				HO_RE_EST_CNT MEDIUMINT(9) DEFAULT ''0'',
				TA_HO_SUM DOUBLE DEFAULT NULL,
				TA_HO_CNT MEDIUMINT(9) DEFAULT ''0'',
				MEAS_COUNT MEDIUMINT(9) DEFAULT ''0'',
				RSRP DOUBLE DEFAULT NULL,
				RSRQ DOUBLE DEFAULT NULL,
				BEST_MEAS_CNT MEDIUMINT(9) DEFAULT ''0'',
				SERVING_RSRP DOUBLE DEFAULT NULL,
				SERVING_RSRQ DOUBLE DEFAULT NULL,
				TA_HO DOUBLE DEFAULT NULL,
				HO_INTERRUP_TIME BIGINT(20) DEFAULT NULL,
				HO_INTERRUP_CNT MEDIUMINT(9) DEFAULT ''0''
				,KEY CALL_ID (CALL_ID,SEQ_ID)
			) ENGINE=MYISAM DEFAULT CHARSET=utf8 DELAY_KEY_WRITE=1;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Intra_Inter_NBO_LTE','step 1', NOW());
	
	SET @SqlCmd=CONCAT('INSERT INTO ',GT_DB,'.tmp_nbo_table_',WORKER_ID,'
			(NBR_ENODEB_ID,NBR_CELL_ID,CALL_ID, SEQ_ID,DATA_HOUR,MEAS_COUNT,RSRP,RSRQ,BEST_MEAS_CNT) 
			SELECT 
				ENODEB_ID AS NBR_ENODEB_ID, CELL_ID AS NBR_CELL_ID,CALL_ID, SEQ_ID,DATA_HOUR 
				,1 AS MEAS_COUNT
				,RSRP
				,RSRQ
				,IF(CELL_FLAG=1,1,0) AS BEST_MEAS_CNT
			FROM ',GT_DB,'.table_position_convert_mr_lte
			WHERE CELL_FLAG < 2;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Intra_Inter_NBO_LTE','step 2', NOW());
	
	SET @SqlCmd=CONCAT('UPDATE ',GT_DB,'.tmp_nbo_table_',WORKER_ID,' A, ',GT_DB,'.table_position_convert_mr_lte B
			SET A.ENODEB_ID = B.ENODEB_ID, A.CELL_ID = B.CELL_ID, A.SERVING_RSRP = B.RSRP, A.SERVING_RSRQ = B.RSRQ
			WHERE A.CALL_ID = B.CALL_ID AND A.SEQ_ID = B.SEQ_ID AND CELL_FLAG > 1;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt; 
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Intra_Inter_NBO_LTE','step 3', NOW());
	
	SET @SqlCmd=CONCAT('INSERT INTO ',GT_DB,'.tmp_nbo_table_',WORKER_ID,' 
			(ENODEB_ID,CELL_ID,NBR_ENODEB_ID,NBR_CELL_ID,DATA_HOUR,HO_COUNT,PINGPONG_HO_CNT,HO_FAIL_CNT,HO_RE_EST_CNT,TA_HO_SUM,TA_HO_CNT,`HO_INTERRUP_TIME`,`HO_INTERRUP_CNT`) 
			SELECT ENODEB_ID,CELL_ID,TARGET_ENODEB AS NBR_ENODEB_ID, TARGET_CELL AS NBR_CELL_ID,DATA_HOUR ,
				IF(EVENT_ID IN (100,105,106,111,112,1107,1108),1,0) AS HO_COUNT,
				IF(PINGPONG_TIMEGAP IS NOT NULL AND 
					EVENT_ID IN (100,105,106,111,112,1107,1108,1111,1112) AND
					PINGPONG_TIMEGAP < ',@PING_PONG_TRIGGER_TIME,',1,0) AS PINGPONG_HO_CNT,
				IF(EVENT_ID IN (1105,1106,1107,1108,1111,1112),1,0) AS HO_FAIL_CNT,
				NULL AS HO_RE_EST_CNT,
				IF(EVENT_ID IN (100,105,106,111,112),TA,0) AS TA_HO_SUM,
				IF(EVENT_ID IN (100,105,106,111,112),1,0) AS TA_HO_CNT,
				SUM(HO_INTERRUP_TIME) AS HO_INTERRUP_TIME,
				COUNT(HO_INTERRUP_TIME) AS HO_INTERRUP_CNT  --  only count not null
			FROM ',GT_DB,'.table_position_convert_ho_lte WHERE event_id IN (100,105,106,111,112,1105,1106,1107,1108)
			GROUP BY ENODEB_ID,CELL_ID,NBR_ENODEB_ID,NBR_CELL_ID,DATA_HOUR;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt; 
	
	SET @SqlCmd=CONCAT('DELETE FROM ',GT_DB,'.tmp_nbo_table_',WORKER_ID,' WHERE ENODEB_ID IS NULL OR NBR_ENODEB_ID IS NULL;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt; 
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Intra_Inter_NBO_LTE','step 4', NOW());
	
	SET @SqlCmd=CONCAT('TRUNCATE TABLE ',GT_DB,'.opt_nbr_inter_intra_lte;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt; 
	
	SET @SqlCmd=CONCAT('INSERT INTO ',GT_DB,'.opt_nbr_inter_intra_lte
				(`ENODEB_ID`,`CELL_ID`,`NBR_ENODEB_ID`,`NBR_CELL_ID`,
				`DATA_HOUR`,`NBR_TYPE`,`DISTANCE_METER`,`HO_COUNT`,
				`PINGPONG_HO_CNT`,`HO_FAIL_CNT`,`HO_RE_EST_CNT`,
				`TA_HO_SUM`,`TA_HO_CNT`,`MEAS_COUNT`,`RSRP_SUM`,
				`RSRQ_SUM`,`RSRP_CNT`,`RSRQ_CNT`,`BEST_MEAS_CNT`,
				`SERVING_RSRP_SUM`,`SERVING_RSRQ_SUM`,`SERVING_RSRP_CNT`,
				`SERVING_RSRQ_CNT`,`HO_INTERRUP_TIME`,`HO_INTERRUP_CNT`)
			SELECT 
				ENODEB_ID,
				CELL_ID,
				NBR_ENODEB_ID,
				NBR_CELL_ID,
				DATA_HOUR,
				NULL AS NBR_TYPE,
				NULL AS DISTANCE_METER,
				SUM(HO_COUNT) AS HO_COUNT,
				SUM(PINGPONG_HO_CNT) AS PINGPONG_HO_CNT,
				SUM(HO_FAIL_CNT) AS HO_FAIL_CNT,
				SUM(HO_RE_EST_CNT) AS HO_RE_EST_CNT,
				SUM(TA_HO_SUM) AS TA_HO_SUM,
				SUM(TA_HO_CNT) AS TA_HO_CNT,
				SUM(MEAS_COUNT) AS MEAS_COUNT,
				SUM(RSRP) AS RSRP_SUM,
				SUM(RSRQ) AS RSRQ_SUM,
				COUNT(RSRP) AS RSRP_CNT,
				COUNT(RSRQ) AS RSRQ_CNT,
				SUM(BEST_MEAS_CNT) AS BEST_MEAS_CNT,
				SUM(SERVING_RSRP) AS SERVING_RSRP_SUM,
				SUM(SERVING_RSRQ) AS SERVING_RSRQ_SUM,
				COUNT(SERVING_RSRP) AS SERVING_RSRP_CNT,
				COUNT(SERVING_RSRQ) AS SERVING_RSRQ_CNT,
				SUM(HO_INTERRUP_TIME) AS HO_INTERRUP_TIME,
				SUM(HO_INTERRUP_CNT) AS HO_INTERRUP_CNT
			FROM ',GT_DB,'.tmp_nbo_table_',WORKER_ID,'
			GROUP BY ENODEB_ID,CELL_ID,NBR_ENODEB_ID,NBR_CELL_ID,DATA_HOUR ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt; 
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Intra_Inter_NBO_LTE','step 5', NOW());
	
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Intra_Inter_NBO_LTE','step 6', NOW());
	
	SET @SqlCmd=CONCAT('UPDATE ',GT_DB,'.opt_nbr_inter_intra_lte A, ',CURRENT_NT_DB,'.nt_cell_current_lte B,',CURRENT_NT_DB,'.nt_cell_current_lte C
			SET A.NBR_TYPE = CASE WHEN B.DL_EARFCN = C.DL_EARFCN THEN 20 ELSE 10 END 
			WHERE A.ENODEB_ID = B.ENODEB_ID AND A.CELL_ID = B.CELL_ID AND A.NBR_ENODEB_ID = C.ENODEB_ID AND A.NBR_CELL_ID = C.CELL_ID;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Intra_Inter_NBO_LTE','step 7', NOW());
	
	SET @SqlCmd=CONCAT('UPDATE ',GT_DB,'.opt_nbr_inter_intra_lte A, ',CURRENT_NT_DB,'.nt_nbr_4_4_current_lte B 
			SET A.NBR_TYPE = B.NBR_TYPE
			WHERE A.ENODEB_ID = B.ENODEB_ID AND A.CELL_ID = B.CELL_ID AND A.NBR_ENODEB_ID = B.NBR_ENODEB_ID AND A.NBR_CELL_ID = B.NBR_CELL_ID;
			');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Intra_Inter_NBO_LTE',CONCAT('Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());
			
END
utf8
utf8_general_ci
latin1_swedish_ci
