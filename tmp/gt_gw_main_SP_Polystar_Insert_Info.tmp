CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Polystar_Insert_Info`(IN TECH_MASK TINYINT(2),IN GT_DB VARCHAR(50),IN gt_polystar_db VARCHAR (20),IN TIME_TYPE VARCHAR(20))
BEGIN
	DECLARE START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE RNC_ID INT;
	DECLARE DATA_DATE VARCHAR(8);
	DECLARE DATA_QRT VARCHAR(4);
	DECLARE DATA_HOUR VARCHAR(4);
	DECLARE FOLDER_PATH VARCHAR(20);
	DECLARE DAILY_DB VARCHAR(25);
	DECLARE SH_EH VARCHAR(9) DEFAULT RIGHT(GT_DB,9);
	DECLARE CURRENT_NT_DB VARCHAR(50) DEFAULT CONCAT('gt_nt_',gt_strtok(GT_DB,3,'_'));
	DECLARE DATA_DATE_END VARCHAR(50);
	
	
 	SELECT gt_strtok(GT_DB,2,'_') INTO RNC_ID;
 	SELECT gt_strtok(GT_DB,3,'_') INTO DATA_DATE;
 	SELECT gt_strtok(GT_DB,4,'_') INTO DATA_QRT;
	SELECT LEFT (DATA_QRT,2) INTO DATA_HOUR;
	
	SET DATA_DATE_END= CONCAT(DATE(DATA_DATE),' 23:59:59');
	SELECT `DAY_OF_WEEK`(DATA_DATE) INTO @DAY_OF_WEEK;
	SET @FIRST_DAY=gt_strtok(@DAY_OF_WEEK, 1, '|');
	SET @END_DAY=gt_strtok(@DAY_OF_WEEK, 2, '|');
	SET @DATE_WK=CONCAT(DATE_FORMAT(@FIRST_DAY,'%Y%m%d'),'_',DATE_FORMAT(@END_DAY,'%Y%m%d'));
	SET @FIRST_DAY_MN=DATE_SUB(DATA_DATE,INTERVAL DAY(DATA_DATE)-1 DAY);
	SET @END_DAY_MN=LAST_DAY(DATA_DATE);
 
	INSERT INTO gt_gw_main.sp_log VALUES('gt_gw_main','SP_Polystar_Insert_Info','START TO INSERT polystar_session_information',NOW());	
	
	IF TECH_MASK IN (0,2,4) AND TIME_TYPE =2 THEN 
	
		SET @SqlCmd=CONCAT('CREATE TABLE IF NOT EXISTS ',gt_polystar_db,'.`polystar_session_information` (
			  `START_DATE` DATETIME NOT NULL,
			  `END_DATE` DATETIME NOT NULL,
			  `DATA_HOUR` TINYINT(4) NOT NULL,
			  `TECH_MASK` TINYINT(4) NOT NULL,
			  `SESSION_TYPE` VARCHAR(10) NOT NULL,
			 PRIMARY KEY (`START_DATE`,`END_DATE`,`DATA_HOUR`,`TECH_MASK`,`SESSION_TYPE`)
			) ENGINE=MYISAM DEFAULT CHARSET=latin1;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		SET @SqlCmd=CONCAT(' REPLACE INTO  ',gt_polystar_db,'.polystar_session_information
				(`START_DATE`,`END_DATE`,`DATA_HOUR`,`TECH_MASK`,`SESSION_TYPE`)
				VALUES( ',DATA_DATE,',''',DATA_DATE_END,''',',DATA_HOUR,',',TECH_MASK,',''DAY'')
				;');	
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	
	END IF;
	
	IF TECH_MASK IN (0,2,4) AND TIME_TYPE =3 THEN 
	
		SET @SqlCmd=CONCAT('CREATE TABLE IF NOT EXISTS ',gt_polystar_db,'.`polystar_session_information` (
			  `START_DATE` DATETIME NOT NULL,
			  `END_DATE` DATETIME NOT NULL,
			  `DATA_HOUR` TINYINT(4) NOT NULL,
			  `TECH_MASK` TINYINT(4) NOT NULL,
			  `SESSION_TYPE` VARCHAR(10) NOT NULL,
			 PRIMARY KEY (`START_DATE`,`END_DATE`,`DATA_HOUR`,`TECH_MASK`,`SESSION_TYPE`)
			) ENGINE=MYISAM DEFAULT CHARSET=latin1;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		SET @SqlCmd=CONCAT(' REPLACE INTO  ',gt_polystar_db,'.polystar_session_information
				(`START_DATE`,`END_DATE`,`DATA_HOUR`,`TECH_MASK`,`SESSION_TYPE`)
				VALUES( ',DATA_DATE,',''',DATA_DATE_END,''',''-1'',',TECH_MASK,',''DAY'')
				;');			
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
	END IF;
	
	
	IF TECH_MASK IN (0,2,4) AND TIME_TYPE =4 THEN 
	
		SET @SqlCmd=CONCAT('CREATE TABLE IF NOT EXISTS ',gt_polystar_db,'.`polystar_session_information` (
			  `START_DATE` DATETIME NOT NULL,
			  `END_DATE` DATETIME NOT NULL,
			  `DATA_HOUR` TINYINT(4) NOT NULL,
			  `TECH_MASK` TINYINT(4) NOT NULL,
			  `SESSION_TYPE` VARCHAR(10) NOT NULL,
			 PRIMARY KEY (`START_DATE`,`END_DATE`,`DATA_HOUR`,`TECH_MASK`,`SESSION_TYPE`)
			) ENGINE=MYISAM DEFAULT CHARSET=latin1;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		SET @SqlCmd=CONCAT(' REPLACE INTO  ',gt_polystar_db,'.polystar_session_information
				(`START_DATE`,`END_DATE`,`DATA_HOUR`,`TECH_MASK`,`SESSION_TYPE`)
				VALUES( ''',@FIRST_DAY,''',''',@END_DAY,''',''-1'',',TECH_MASK,',''WEEK'')
				;');			
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	
	END IF;
	
	IF TECH_MASK IN (0,2,4) AND TIME_TYPE =5 THEN 
	
		SET @SqlCmd=CONCAT('CREATE TABLE IF NOT EXISTS ',gt_polystar_db,'.`polystar_session_information` (
			  `START_DATE` DATETIME NOT NULL,
			  `END_DATE` DATETIME NOT NULL,
			  `DATA_HOUR` TINYINT(4) NOT NULL,
			  `TECH_MASK` TINYINT(4) NOT NULL,
			  `SESSION_TYPE` VARCHAR(10) NOT NULL,
			 PRIMARY KEY (`START_DATE`,`END_DATE`,`DATA_HOUR`,`TECH_MASK`,`SESSION_TYPE`)
			) ENGINE=MYISAM DEFAULT CHARSET=latin1;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		SET @SqlCmd=CONCAT(' REPLACE INTO  ',gt_polystar_db,'.polystar_session_information
				(`START_DATE`,`END_DATE`,`DATA_HOUR`,`TECH_MASK`,`SESSION_TYPE`)
				VALUES( ''',@FIRST_DAY_MN,''',''',@END_DAY_MN,''',''-1'',',TECH_MASK,',''MONTH'')
				;');			
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	
	END IF;
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Polystar_Insert_Info',CONCAT('Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());
 END
utf8
utf8_general_ci
latin1_swedish_ci
