CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI`(IN DATA_DATE DATE,IN DATA_HOUR TINYINT(2),IN PU_ID MEDIUMINT(9),IN TECH_MASK TINYINT(2), IN GT_DB VARCHAR(100), WORKER_ID VARCHAR(10),IN IMSI_CELL TINYINT(2))
BEGIN
	DECLARE START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE STEP_START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE SP_Process VARCHAR(100) DEFAULT NULL;
	DECLARE SUB_WORKER_ID VARCHAR(10) DEFAULT CONNECTION_ID();
	DECLARE KPI_ERROR CONDITION FOR SQLSTATE '99999' ;
	
	SET @EX_DATE=CONCAT(DATE_FORMAT(DATA_DATE,'%Y%m%d_'),DATA_HOUR,'_',WORKER_ID);
	
	SET @SqlCmd=CONCAT('SELECT `att_value` INTO @ZOOM_LEVEL FROM gt_covmo.`sys_config` WHERE `group_name`=''system'' AND att_name = ''MapResolution'';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
  	call gt_gw_main.`SP_Sub_Set_Session_Param_LTE`('');
	
	IF TECH_MASK=2 THEN 
		SET SP_Process = 'SP_Generate_Global_Statistic_imsi_umts';
		SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS gt_global_statistic.tmp_imsi_umts_',PU_ID,'_',SUB_WORKER_ID,';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE gt_global_statistic.tmp_imsi_umts_',PU_ID,'_',SUB_WORKER_ID,' 
					(
					`IMSI` VARCHAR(20) NOT NULL,
					`DATA_DATE` DATETIME NOT NULL,
					`DATA_HOUR` TINYINT(2) NOT NULL,
					`CALL_CNT` int(11) DEFAULT NULL,
					`VOICE_MO_CNT` int(11) DEFAULT NULL,
					`VOICE_MT_CNT` int(11) DEFAULT NULL,
					`VIDEO_MO_CNT` int(11) DEFAULT NULL,
					`VIDEO_MT_CNT` int(11) DEFAULT NULL,
					`R99_MO_CNT` int(11) DEFAULT NULL,
					`R99_MT_CNT` int(11) DEFAULT NULL,
					`HSPA_MO_CNT` int(11) DEFAULT NULL,
					`HSPA_MT_CNT` int(11) DEFAULT NULL,
					`MRAB_MO_CNT` int(11) DEFAULT NULL,
					`MRAB_MT_CNT` int(11) DEFAULT NULL,
					`SIGNAL_MO_CNT` int(11) DEFAULT NULL,
					`SIGNAL_MT_CNT` int(11) DEFAULT NULL,
					`SMS_MO_CNT` int(11) DEFAULT NULL,
					`SMS_MT_CNT` int(11) DEFAULT NULL,
					`PS_OTHER_CNT` int(11) DEFAULT NULL,
					`CALL_DUR_SUM` double DEFAULT NULL,
					`VOICE_DUR_SUM` double DEFAULT NULL,
					`VIDEO_DUR_SUM` double DEFAULT NULL,
					`R99_DUR_SUM` double DEFAULT NULL,
					`HSPA_DUR_SUM` double DEFAULT NULL,
					`MRAB_DUR_SUM` double DEFAULT NULL,
					`DROP_CNT` int(11) DEFAULT NULL,
					`DROP_VOICE_CNT` int(11) DEFAULT NULL,
					`DROP_VEDIO_CNT` int(11) DEFAULT NULL,
					`DROP_R99_CNT` int(11) DEFAULT NULL,
					`DROP_HSPA_CNT` int(11) DEFAULT NULL,
					`DROP_MRAB_CNT` int(11) DEFAULT NULL,
					`DROP_SMS_CNT` int(11) DEFAULT NULL,
					`DROP_SIGNAL_CNT` int(11) DEFAULT NULL,
					`DROP_PS_OTHER_CNT` int(11) DEFAULT NULL,
					`DROP_RF_CNT` int(11) DEFAULT NULL,
					`DROP_CONG_CNT` int(11) DEFAULT NULL,
					`DROP_TRANS_CNT` int(11) DEFAULT NULL,
					`DROP_SHO_CNT` int(11) DEFAULT NULL,
					`DROP_HHO_CNT` int(11) DEFAULT NULL,
					`DROP_IRAT_CNT` int(11) DEFAULT NULL,
					`BLOCK_CNT` int(11) DEFAULT NULL,
					`BLOCK_VOICE_CNT` int(11) DEFAULT NULL,
					`BLOCK_VEDIO_CNT` int(11) DEFAULT NULL,
					`BLOCK_R99_CNT` int(11) DEFAULT NULL,
					`BLOCK_HSPA_CNT` int(11) DEFAULT NULL,
					`BLOCK_MRAB_CNT` int(11) DEFAULT NULL,
					`BLOCK_SMS_CNT` int(11) DEFAULT NULL,
					`BLOCK_SMS_MT_CNT` int(11) DEFAULT NULL,
					`BLOCK_SMS_MO_CNT` int(11) DEFAULT NULL,
					`BLOCK_SIGNAL_CNT` int(11) DEFAULT NULL,
					`BLOCK_PS_OTHER_CNT` int(11) DEFAULT NULL,
					`SHO_ATTEMPT_CNT` int(11) DEFAULT NULL,
					`SHO_FAILURE_CNT` int(11) DEFAULT NULL,
					`HHO_ATTEMPT_CNT` int(11) DEFAULT NULL,
					`HHO_FAILURE_CNT` int(11) DEFAULT NULL,
					`IRAT_ATTEMPT_CNT` int(11) DEFAULT NULL,
					`IRAT_FAILURE_CNT` int(11) DEFAULT NULL,
					`MOVING_CALL_CNT` int(11) DEFAULT NULL,
					`INDOOR_CALL_CNT` int(11) DEFAULT NULL,
					`PS_UL_VOLUME_SUM` double DEFAULT NULL,
					`PS_DL_VOLUME_SUM` double DEFAULT NULL,
					`PS_UL_SPEED_MAX` double DEFAULT NULL,
					`PS_DL_SPEED_MAX` double DEFAULT NULL,
					`FIRST_RSCP_SUM` double DEFAULT NULL,
					`FIRST_RSCP_CNT` int(11) DEFAULT NULL,
					`FIRST_ECNO_SUM` double DEFAULT NULL,
					`FIRST_ECNO_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VOICE_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VOICE_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VEDIO_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VEDIO_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_R99_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_R99_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_HSPA_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_HSPA_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_MRAB_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_MRAB_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SIG_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SIG_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_OTH_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_OTH_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SMS_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SMS_CNT` int(11) DEFAULT NULL,
					`SF_CNT` int(11) DEFAULT NULL,
					`SF_VOICE_CNT` int(11) DEFAULT NULL,
					`SF_VEDIO_CNT` int(11) DEFAULT NULL,
					`SF_R99_CNT` int(11) DEFAULT NULL,
					`SF_HSPA_CNT` int(11) DEFAULT NULL,
					`SF_MRAB_CNT` int(11) DEFAULT NULL,
					`SF_SMS_CNT` int(11) DEFAULT NULL,
					`SF_SMS_MT_CNT` int(11) DEFAULT NULL,
					`SF_SMS_MO_CNT` int(11) DEFAULT NULL,
					`SF_SIGNAL_CNT` int(11) DEFAULT NULL,
					`SF_PS_OTHER_CNT` int(11) DEFAULT NULL,
					`PDP_ACTIVATION_REQUEST` int(11) DEFAULT NULL,
					`PDP_ACTIVATION_ACCEPT` int(11) DEFAULT NULL,
					`PDP_DEACTIVATION_REQUEST` int(11) DEFAULT NULL,
					`PDP_DEACTIVATION_ACCEPT` int(11) DEFAULT NULL,
					`AUTH_REQUEST` int(11) DEFAULT NULL,
					`AUTH_RESPONSE` int(11) DEFAULT NULL,
					`AUTH_CIPH_REQUEST` int(11) DEFAULT NULL,
					`AUTH_CIPH_RESPONSE` int(11) DEFAULT NULL,
					`SECURITY_MODE_ATT` int(11) DEFAULT NULL,
					`SECURITY_MODE_SUCCESS` int(11) DEFAULT NULL,
					`LU_REQUEST` int(11) DEFAULT NULL,
					`LU_ACCEPT` int(11) DEFAULT NULL,
					`RAU_REQUEST` int(11) DEFAULT NULL,
					`RAU_ACCEPT` int(11) DEFAULT NULL,
					`MAKE_ID` INT(11) DEFAULT NULL,
					`MODEL_ID` INT(11) DEFAULT NULL,
					',CASE WHEN IMSI_CELL=1 THEN '
					`START_TILE_ID` BIGINT(20) DEFAULT NULL,
					`END_TILE_ID` BIGINT(20) DEFAULT NULL,
					`START_CELL_ID` MEDIUMINT(9) DEFAULT NULL,
					`START_SITE_ID` VARCHAR(20) DEFAULT NULL,
					`START_REG_1_ID` BIGINT(20) DEFAULT NULL,
					`START_REG_2_ID` BIGINT(20) DEFAULT NULL,
					`START_REG_3_ID` BIGINT(20) DEFAULT NULL,
					`END_CELL_ID` MEDIUMINT(9) DEFAULT NULL,
					`END_SITE_ID` VARCHAR(20) DEFAULT NULL,
					`END_REG_1_ID` BIGINT(20) DEFAULT NULL,
					`END_REG_2_ID` BIGINT(20) DEFAULT NULL,
					`END_REG_3_ID` BIGINT(20) DEFAULT NULL,' ELSE '' END,'
					`MAKE_MODEL` varchar(200) DEFAULT NULL
					) ENGINE=MYISAM DEFAULT CHARSET=latin1 DELAY_KEY_WRITE=1;');
		
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		INSERT INTO gt_gw_main.sp_log VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT(GT_DB,' INSERT INTO tbl_',GT_DB,'_',WORKER_ID), NOW());	
		SET @SqlCmd=CONCAT('SELECT spider_bg_direct_sql(CONCAT(''CALL gt_global_statistic.',SP_Process,'(''''',DATA_DATE,''''',',DATA_HOUR,',',PU_ID,',',TECH_MASK,',''''',GT_DB,''''',',IMSI_CELL,');'') 
					, ''gt_global_statistic.tmp_imsi_umts_',PU_ID,'_',SUB_WORKER_ID,'''
					, CONCAT(''HOST '''''',REPLACE(gt_strtok(DS_AP_URI,3,'':''),''/'',''''),'''''', PORT '''''',REPLACE(gt_strtok(DS_AP_URI,4,'':''),''/'',''''),'''''',USER '''''',`DS_AP_USER`,'''''', PASSWORD '''''',`DS_AP_PASSWORD`,'''''''')
					) INTO @bb FROM `gt_covmo`.`rnc_information` WHERE `RNC`=',PU_ID,' AND `TECHNOLOGY`=''UMTS''
					;');
		
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	 	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('SELECT spider_bg_direct_sql,umts:',GT_DB,'_',WORKER_ID), NOW());
		SET STEP_START_TIME := SYSDATE();
		
		IF @bb=1 THEN 			
			SET @SqlCmd=CONCAT('INSERT INTO gt_global_statistic.tmp_imsi_umts_',@EX_DATE,'
						SELECT * FROM gt_global_statistic.tmp_imsi_umts_',PU_ID,'_',SUB_WORKER_ID,';');
			PREPARE Stmt FROM @SqlCmd;
			EXECUTE Stmt;
			DEALLOCATE PREPARE Stmt;
			INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('tmp_imsi_umts_',PU_ID,'_',SUB_WORKER_ID,' INSERT tmp_cell_tile_umts cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
			SET STEP_START_TIME := SYSDATE();		
			
			SET @SqlCmd=CONCAT('UPDATE gt_global_statistic.tmp_table_call_cnt_',WORKER_ID,' 
						SET `IsSuccess`=1
						WHERE `DATA_DATE`=''',DATA_DATE,''' AND `DATA_HOUR`=',DATA_HOUR,'
							AND `PU_ID`=',PU_ID,' AND `TECH_MASK`=',TECH_MASK,'
						;');
	
			PREPARE Stmt FROM @SqlCmd;
			EXECUTE Stmt;
			DEALLOCATE PREPARE Stmt;
			INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('UPDATE tmp_table_call_cnt_',PU_ID,'_',SUB_WORKER_ID,' INSERT tmp_cell_tile_lte cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
		ELSE
			INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('INSERT ERROR,tmp_imsi_umts_',PU_ID,'_',SUB_WORKER_ID), NOW());
			INSERT INTO `gt_gw_main`.`tbl_rpt_error` (`PID`,`CreateTime`,`error_str`) VALUES (WORKER_ID,NOW(),'Spider SP EXECUTE Failed - SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI');
			SIGNAL KPI_ERROR
				SET MESSAGE_TEXT = 'Spider SP EXECUTE Failed - SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI';
		END IF;	
	ELSEIF TECH_MASK=4 THEN 	
		SET SP_Process = 'SP_Generate_Global_Statistic_imsi_lte';
		SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS gt_global_statistic.tmp_imsi_lte_',PU_ID,'_',SUB_WORKER_ID,';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;	
	
		SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE gt_global_statistic.tmp_imsi_lte_',PU_ID,'_',SUB_WORKER_ID,' 
				(
					`IMSI` varchar(20) NOT NULL,
					`DATA_DATE` DATETIME NOT NULL,
					`DATA_HOUR` tinyint(2) NOT NULL,
					`CALL_CNT` int(11) DEFAULT NULL,
					`DATA_CNT` int(11) DEFAULT NULL,
					`SIGNAL_CNT` int(11) DEFAULT NULL,
					`SMS_CNT` int(11) DEFAULT NULL,
					`VOLTE_CNT` int(11) DEFAULT NULL,
					`UNSPECIFIED_CNT` int(11) DEFAULT NULL,
					`CALL_DUR_SUM` double DEFAULT NULL,
					`DATA_DUR_SUM` double DEFAULT NULL,
					`SIGNAL_DUR_SUM` double DEFAULT NULL,
					`DROP_CNT` int(11) DEFAULT NULL,
					`DROP_DATA_CNT` int(11) DEFAULT NULL,
					`DROP_SIGNAL_CNT` int(11) DEFAULT NULL,
					`DROP_SMS_CNT` int(11) DEFAULT NULL,
					`DROP_VOLTE_CNT` int(11) DEFAULT NULL,
					`DROP_UNSPECIFIED_CNT` int(11) DEFAULT NULL,
					`BLOCK_CNT` int(11) DEFAULT NULL,
					`BLOCK_DATA_CNT` int(11) DEFAULT NULL,
					`BLOCK_SIGNAL_CNT` int(11) DEFAULT NULL,
					`BLOCK_SMS_CNT` int(11) DEFAULT NULL,
					`BLOCK_SMS_MT_CNT` int(11) DEFAULT NULL,
					`BLOCK_SMS_MO_CNT` int(11) DEFAULT NULL,
					`BLOCK_VOLTE_CNT` int(11) DEFAULT NULL,
					`BLOCK_UNSPECIFIED_CNT` int(11) DEFAULT NULL,
					`DROP_RDO_NW_CNT` int(11) DEFAULT NULL,
					`DROP_TRANS_CNT` int(11) DEFAULT NULL,
					`DROP_NAS_CNT` int(11) DEFAULT NULL,
					`DROP_MISC_CNT` int(11) DEFAULT NULL,
					`DROP_PROTOCOL_CNT` int(11) DEFAULT NULL,
					`INTER_FREQ_ATTEMPT_CNT` int(11) DEFAULT NULL,
					`INTER_FREQ_FAILURE_CNT` int(11) DEFAULT NULL,
					`INTRA_FREQ_ATTEMPT_CNT` int(11) DEFAULT NULL,
					`INTRA_FREQ_FAILURE_CNT` int(11) DEFAULT NULL,
					`4G_3G_ATTEMPT_CNT` int(11) DEFAULT NULL,
					`4G_3G_FAILURE_CNT` int(11) DEFAULT NULL,
					`4G_2G_ATTEMPT_CNT` int(11) DEFAULT NULL,
					`4G_2G_FAILURE_CNT` int(11) DEFAULT NULL,
					`MOVING_CALL_CNT` int(11) DEFAULT NULL,
					`INDOOR_CALL_CNT` int(11) DEFAULT NULL,
					`PS_UL_VOLUME_SUM` double DEFAULT NULL,
					`PS_DL_VOLUME_SUM` double DEFAULT NULL,
					`PS_UL_SPEED_MAX` double DEFAULT NULL,
					`PS_DL_SPEED_MAX` double DEFAULT NULL,
					`FIRST_RSRP_SUM` double DEFAULT NULL,
					`FIRST_RSRP_CNT` int(11) DEFAULT NULL,
					`FIRST_RSRQ_SUM` double DEFAULT NULL,
					`FIRST_RSRQ_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SUM` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_CNT` int(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SIG_SUM` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SIG_CNT` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_DATA_SUM` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_DATA_CNT` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SMS_SUM` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_SMS_CNT` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VOLTE_SUM` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_VOLTE_CNT` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_UNSP_SUM` INT(11) DEFAULT NULL,
					`CALL_SETUP_TIME_UNSP_CNT` INT(11) DEFAULT NULL,
					`SF_CNT` int(11) DEFAULT NULL,
					`SF_DATA_CNT` int(11) DEFAULT NULL,
					`SF_SIGNAL_CNT` int(11) DEFAULT NULL,
					`SF_SMS_CNT` int(11) DEFAULT NULL,
					`SF_SMS_MT_CNT` int(11) DEFAULT NULL,
					`SF_SMS_MO_CNT` int(11) DEFAULT NULL,
					`SF_VOLTE_CNT` int(11) DEFAULT NULL,
					`SF_UNSPECIFIED_CNT` int(11) DEFAULT NULL,
					`MT_DATA_CNT` int(11) DEFAULT NULL,
					`MO_DATA_CNT` int(11) DEFAULT NULL,
					`MT_SMS_CNT` int(11) DEFAULT NULL,
					`MO_SMS_CNT` int(11) DEFAULT NULL,
					`MT_VOLTE_CNT` int(11) DEFAULT NULL,
					`MO_VOLTE_CNT` int(11) DEFAULT NULL,
					`CSFB_SIGNAL_CNT` INT(11) DEFAULT NULL,
					`CSFB_DATA_CNT` INT(11) DEFAULT NULL,
					`CSFB_SMS_CNT` INT(11) DEFAULT NULL,
					`CSFB_VOLTE_CNT` INT(11) DEFAULT NULL,
					`CSFB_UNSPECIFIED_CNT` INT(11) DEFAULT NULL,
					`CSFB_CNT` INT(11) DEFAULT NULL,
					`LATENCY_SUM` DOUBLE DEFAULT NULL,
					`LATENCY_CNT` INT(11) DEFAULT NULL,
					`MAKE_ID` int(11) DEFAULT NULL,
					`MODEL_ID` int(11) DEFAULT NULL,
					',CASE WHEN IMSI_CELL=1 THEN '
					`START_TILE_ID` BIGINT(20) DEFAULT NULL,
					`END_TILE_ID` BIGINT(20) DEFAULT NULL,
					`START_CELL_ID` TINYINT(4) UNSIGNED DEFAULT NULL,
					`START_ENODEB_ID` MEDIUMINT(9) DEFAULT NULL,
					`START_REG_1_ID` BIGINT(20) DEFAULT NULL,
					`START_REG_2_ID` BIGINT(20) DEFAULT NULL,
					`START_REG_3_ID` BIGINT(20) DEFAULT NULL,
					`END_CELL_ID` TINYINT(4) UNSIGNED DEFAULT NULL,
					`END_ENODEB_ID` MEDIUMINT(9) DEFAULT NULL,
					`END_REG_1_ID` BIGINT(20) DEFAULT NULL,
					`END_REG_2_ID` BIGINT(20) DEFAULT NULL,
					`END_REG_3_ID` BIGINT(20) DEFAULT NULL,' ELSE '' END,'
					`MAKE_MODEL` varchar(200) DEFAULT NULL
				) ENGINE=MYISAM DEFAULT CHARSET=utf8;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		SET @SqlCmd=CONCAT('SELECT spider_bg_direct_sql(CONCAT(''CALL gt_global_statistic.',SP_Process,'(''''',DATA_DATE,''''',',DATA_HOUR,',',PU_ID,',',TECH_MASK,',''''',GT_DB,''''',',IMSI_CELL,');'') 
					, ''gt_global_statistic.tmp_imsi_lte_',PU_ID,'_',SUB_WORKER_ID,'''
					, CONCAT(''HOST '''''',REPLACE(gt_strtok(DS_AP_URI,3,'':''),''/'',''''),'''''', PORT '''''',REPLACE(gt_strtok(DS_AP_URI,4,'':''),''/'',''''),'''''',USER '''''',`DS_AP_USER`,'''''', PASSWORD '''''',`DS_AP_PASSWORD`,'''''''')
					) INTO @bb FROM `gt_covmo`.`rnc_information` WHERE `RNC`=',PU_ID,' AND `TECHNOLOGY`=''LTE''
					;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	 	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('spider_bg_direct_sql tmp_imsi_lte_',PU_ID,'_',SUB_WORKER_ID,' cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
		SET STEP_START_TIME := SYSDATE();
	
		IF @bb=1 THEN 
			SET @SqlCmd=CONCAT('INSERT INTO gt_global_statistic.tmp_imsi_lte_',@EX_DATE,'
						SELECT * FROM gt_global_statistic.tmp_imsi_lte_',PU_ID,'_',SUB_WORKER_ID,';');
			PREPARE Stmt FROM @SqlCmd;
			EXECUTE Stmt;
			DEALLOCATE PREPARE Stmt;
			INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('tmp_imsi_lte_',PU_ID,'_',SUB_WORKER_ID,' INSERT tmp_cell_tile_lte cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
			SET STEP_START_TIME := SYSDATE();		
			
			SET @SqlCmd=CONCAT('UPDATE gt_global_statistic.tmp_table_call_cnt_',WORKER_ID,' 
						SET `IsSuccess`=1
						WHERE `DATA_DATE`=''',DATA_DATE,''' AND `DATA_HOUR`=',DATA_HOUR,'
							AND `PU_ID`=',PU_ID,' AND `TECH_MASK`=',TECH_MASK,'
						;');
			PREPARE Stmt FROM @SqlCmd;
			EXECUTE Stmt;
			DEALLOCATE PREPARE Stmt;
			INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('UPDATE tmp_table_call_cnt_',PU_ID,'_',SUB_WORKER_ID,' INSERT tmp_cell_tile_lte cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
		ELSE
			INSERT INTO `gt_gw_main`.`tbl_rpt_error` (`PID`,`CreateTime`,`error_str`) VALUES (WORKER_ID,NOW(),'Spider SP EXECUTE Failed - SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI');
			SIGNAL KPI_ERROR
				SET MESSAGE_TEXT = 'Spider SP EXECUTE Failed - SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI';
	 		INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('INSERT ERROR,tmp_imsi_lte_',PU_ID,'_',SUB_WORKER_ID,' cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
			SET STEP_START_TIME := SYSDATE();
		END IF;	
			
		SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS gt_global_statistic.tmp_imsi_lte_',PU_ID,'_',SUB_WORKER_ID,';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
					
	 	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('DROP tmp_imsi_lte_,',PU_ID,'_',SUB_WORKER_ID,' cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
		SET STEP_START_TIME := SYSDATE();	
	ELSEIF TECH_MASK=1 THEN 	
		SET SP_Process = 'SP_Generate_Global_Statistic_imsi_gsm';
		SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS gt_global_statistic.tmp_imsi_gsm_',PU_ID,'_',SUB_WORKER_ID,';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;	
	
		SET @SqlCmd=CONCAT('CREATE TEMPORARY TABLE gt_global_statistic.tmp_imsi_gsm_',PU_ID,'_',SUB_WORKER_ID,' 
				(
					`IMSI` VARCHAR(20) NOT NULL,
					`DATA_DATE` DATETIME NOT NULL,
					`DATA_HOUR` TINYINT(2) NOT NULL,
					CALL_CNT int(11) DEFAULT NULL,
					VOICE_MO_CNT int(11) DEFAULT NULL,
					VOICE_MT_CNT int(11) DEFAULT NULL,
					DATA_MO_CNT int(11) DEFAULT NULL,
					DATA_MT_CNT int(11) DEFAULT NULL,
					SMS_MO_CNT int(11) DEFAULT NULL,
					SMS_MT_CNT int(11) DEFAULT NULL,
					SIGNAL_CNT int(11) DEFAULT NULL,
					CALL_DUR_SUM int(11) DEFAULT NULL,
					VOICE_DUR_SUM int(11) DEFAULT NULL,
					DATA_DUR_SUM int(11) DEFAULT NULL,
					DROP_CNT int(11) DEFAULT NULL,
					BLOCK_CNT int(11) DEFAULT NULL,
					DROP_VOICE_CNT int(11) DEFAULT NULL,
					DROP_GPRS_CNT int(11) DEFAULT NULL,
					DROP_SMS_CNT int(11) DEFAULT NULL,
					DROP_SIGNAL_CNT int(11) DEFAULT NULL,
					DROP_OTHER_CNT int(11) DEFAULT NULL,
					BLOCK_VOICE_CNT int(11) DEFAULT NULL,
					BLOCK_GPRS_CNT int(11) DEFAULT NULL,
					BLOCK_SMS_CNT int(11) DEFAULT NULL,
					BLOCK_SMS_MT_CNT int(11) DEFAULT NULL,
					BLOCK_SMS_MO_CNT int(11) DEFAULT NULL,
					BLOCK_SIGNAL_CNT int(11) DEFAULT NULL,
					BLOCK_OTHER_CNT int(11) DEFAULT NULL,
					HO_ATTEMPT_CNT int(11) DEFAULT NULL,
					HO_FAILURE_CNT int(11) DEFAULT NULL,
					MOVING_CALL_CNT int(11) DEFAULT NULL,
					INDOOR_CALL_CNT int(11) DEFAULT NULL,
					FIRST_RXLEV_DL_SUM double DEFAULT NULL,
					FIRST_RXLEV_DL_CNT int(11) DEFAULT NULL,
					FIRST_RXQUAL_DL_SUM double DEFAULT NULL,
					FIRST_RXQUAL_DL_CNT int(11) DEFAULT NULL,
					FIRST_RXLEV_UL_SUM double DEFAULT NULL,
					FIRST_RXLEV_UL_CNT int(11) DEFAULT NULL,
					FIRST_RXQUAL_UL_SUM double DEFAULT NULL,
					FIRST_RXQUAL_UL_CNT int(11) DEFAULT NULL,
					CALL_SETUP_TIME_SUM int(11) DEFAULT NULL,
					CALL_SETUP_TIME_CNT int(11) DEFAULT NULL,
					CALL_SETUP_TIME_VOICE_SUM int(11) DEFAULT NULL,
					CALL_SETUP_TIME_VOICE_CNT int(11) DEFAULT NULL,
					CALL_SETUP_TIME_SIG_SUM int(11) DEFAULT NULL,
					CALL_SETUP_TIME_SIG_CNT int(11) DEFAULT NULL,
					CALL_SETUP_TIME_SMS_SUM int(11) DEFAULT NULL,
					CALL_SETUP_TIME_SMS_CNT int(11) DEFAULT NULL,
					CALL_SETUP_TIME_GPRS_SUM int(11) DEFAULT NULL,
					CALL_SETUP_TIME_GPRS_CNT int(11) DEFAULT NULL,
					CALL_SETUP_TIME_OTH_SUM int(11) DEFAULT NULL,
					CALL_SETUP_TIME_OTH_CNT int(11) DEFAULT NULL,
					SF_VOICE_CNT int(11) DEFAULT NULL,
					SF_GPRS_CNT int(11) DEFAULT NULL,
					SF_SMS_CNT int(11) DEFAULT NULL,
					SF_SMS_MT_CNT int(11) DEFAULT NULL,
					SF_SMS_MO_CNT int(11) DEFAULT NULL,
					SF_SIGNAL_CNT int(11) DEFAULT NULL,
					SF_OTHER_CNT int(11) DEFAULT NULL,
					`MAKE_ID` INT(11) DEFAULT NULL,
					`MODEL_ID` INT(11) DEFAULT NULL,
					',CASE WHEN IMSI_CELL=1 THEN '
					`START_TILE_ID` BIGINT(20) DEFAULT NULL,
					`END_TILE_ID` BIGINT(20) DEFAULT NULL,
					`START_CELL_ID` MEDIUMINT(9) DEFAULT NULL,
					`START_SITE_ID` VARCHAR(20) DEFAULT NULL,
					`START_REG_1_ID` BIGINT(20) DEFAULT NULL,
					`START_REG_2_ID` BIGINT(20) DEFAULT NULL,
					`START_REG_3_ID` BIGINT(20) DEFAULT NULL,
					`END_CELL_ID` MEDIUMINT(9) DEFAULT NULL,
					`END_SITE_ID` VARCHAR(20) DEFAULT NULL,
					`END_REG_1_ID` BIGINT(20) DEFAULT NULL,
					`END_REG_2_ID` BIGINT(20) DEFAULT NULL,
					`END_REG_3_ID` BIGINT(20) DEFAULT NULL,' ELSE '' END,'
					`MAKE_MODEL` varchar(200) DEFAULT NULL
				) ENGINE=MYISAM DEFAULT CHARSET=utf8;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		SET @SqlCmd=CONCAT('SELECT spider_bg_direct_sql(CONCAT(''CALL gt_global_statistic.',SP_Process,'(''''',DATA_DATE,''''',',DATA_HOUR,',',PU_ID,',',TECH_MASK,',''''',GT_DB,''''',',IMSI_CELL,');'') 
					, ''gt_global_statistic.tmp_imsi_gsm_',PU_ID,'_',SUB_WORKER_ID,'''
					, CONCAT(''HOST '''''',REPLACE(gt_strtok(DS_AP_URI,3,'':''),''/'',''''),'''''', PORT '''''',REPLACE(gt_strtok(DS_AP_URI,4,'':''),''/'',''''),'''''',USER '''''',`DS_AP_USER`,'''''', PASSWORD '''''',`DS_AP_PASSWORD`,'''''''')
					) INTO @bb FROM `gt_covmo`.`rnc_information` WHERE `RNC`=',PU_ID,' AND `TECHNOLOGY`=''GSM''
					;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	 	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('spider_bg_direct_sql tmp_imsi_gsm_',PU_ID,'_',SUB_WORKER_ID,' cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
		SET STEP_START_TIME := SYSDATE();
	
		IF @bb=1 THEN 
			SET @SqlCmd=CONCAT('INSERT INTO gt_global_statistic.tmp_imsi_gsm_',@EX_DATE,'
						SELECT * FROM gt_global_statistic.tmp_imsi_gsm_',PU_ID,'_',SUB_WORKER_ID,';');
			PREPARE Stmt FROM @SqlCmd;
			EXECUTE Stmt;
			DEALLOCATE PREPARE Stmt;
			INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('tmp_imsi_gsm_',PU_ID,'_',SUB_WORKER_ID,' INSERT tmp_cell_tile_lte cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
			SET STEP_START_TIME := SYSDATE();		
			
			SET @SqlCmd=CONCAT('UPDATE gt_global_statistic.tmp_table_call_cnt_',WORKER_ID,' 
						SET `IsSuccess`=1
						WHERE `DATA_DATE`=''',DATA_DATE,''' AND `DATA_HOUR`=',DATA_HOUR,'
							AND `PU_ID`=',PU_ID,' AND `TECH_MASK`=',TECH_MASK,'
						;');
			PREPARE Stmt FROM @SqlCmd;
			EXECUTE Stmt;
			DEALLOCATE PREPARE Stmt;
			INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('UPDATE tmp_table_call_cnt_',PU_ID,'_',SUB_WORKER_ID,' INSERT tmp_cell_tile_lte cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
		ELSE
			INSERT INTO `gt_gw_main`.`tbl_rpt_error` (`PID`,`CreateTime`,`error_str`) VALUES (WORKER_ID,NOW(),'Spider SP EXECUTE Failed - SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI');
			SIGNAL KPI_ERROR
				SET MESSAGE_TEXT = 'Spider SP EXECUTE Failed - SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI';
	 		INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('INSERT ERROR,tmp_imsi_gsm_',PU_ID,'_',SUB_WORKER_ID,' cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
			SET STEP_START_TIME := SYSDATE();
		END IF;	
			
		SET @SqlCmd=CONCAT('DROP TEMPORARY TABLE IF EXISTS gt_global_statistic.tmp_imsi_gsm_',PU_ID,'_',SUB_WORKER_ID,';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
					
	 	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT('DROP tmp_imsi_gsm_,',PU_ID,'_',SUB_WORKER_ID,' cost:',TIMESTAMPDIFF(SECOND,STEP_START_TIME,SYSDATE()),' sec.'), NOW());
		SET STEP_START_TIME := SYSDATE();
	END IF;	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Global_Statistic_Sub_TmpTbl_IMSI',CONCAT(DATA_DATE,',',DATA_HOUR,',',PU_ID,',',TECH_MASK,',',PU_ID,'_',SUB_WORKER_ID,' Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());
    END
utf8
utf8_general_ci
latin1_swedish_ci
