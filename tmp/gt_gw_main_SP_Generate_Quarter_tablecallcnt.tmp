CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Generate_Quarter_tablecallcnt`(IN GT_DB VARCHAR(100), IN TECH_MASK TINYINT(2),IN GT_COVMO VARCHAR(100), IN BITMASK TINYINT(2), IN note VARCHAR(500))
BEGIN
	DECLARE RNC_ID INT;
	DECLARE START_TIME DATETIME DEFAULT SYSDATE();		
 	DECLARE DATAHOUR VARCHAR(2) DEFAULT SUBSTRING(RIGHT(GT_DB,18),10,2);
	DECLARE ORG_DATE_DATE VARCHAR(20) DEFAULT SUBSTRING(RIGHT(GT_DB,18),1,8);
	DECLARE DATA_DATE VARCHAR(20) ;
	DECLARE SH_EH VARCHAR(9) DEFAULT RIGHT(GT_DB,9);
	DECLARE WORKER_ID VARCHAR(10) DEFAULT CONNECTION_ID();
	
	SET GT_DB=REPLACE(GT_DB,SH_EH,'0000_0000') ;
	SET DATA_DATE = CONCAT(SUBSTRING(ORG_DATE_DATE,1,4),'-',SUBSTRING(ORG_DATE_DATE,5,2),'-',SUBSTRING(ORG_DATE_DATE,7,2));	
	SET RNC_ID= gt_strtok(GT_DB,2,'_');
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Quarter_tablecallcnt','Start', START_TIME);
	

	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Quarter_tablecallcnt',CONCAT('DELETE ',GT_DB,SH_EH), NOW());
	SET @SqlCmd=CONCAT(' DROP TEMPORARY TABLE IF EXISTS ',GT_DB,'.table_call_cnt_',WORKER_ID,' ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;	
	
	SET @SqlCmd=CONCAT(' CREATE TEMPORARY TABLE ',GT_DB,'.table_call_cnt_',WORKER_ID,' LIKE gt_gw_main.table_call_cnt;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Quarter_tablecallcnt',CONCAT('INSERT ',GT_DB,SH_EH), NOW());
	SET @SqlCmd=CONCAT('INSERT INTO ',GT_DB,'.table_call_cnt_',WORKER_ID,' 
						( DATA_DATE,DATA_HOUR,PU_ID,SERVICETYPE,TOT_CALL_CNT,TECH_MASK,NOTE)
						SELECT ''',DATA_DATE,''',',DATAHOUR,',',RNC_ID,',''QR'' ,',BITMASK,',',TECH_MASK,',''',note,''';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Quarter_tablecallcnt','Insert gt_gw_main', NOW());
	SET @SqlCmd=CONCAT('
			INSERT INTO gt_gw_main.table_call_cnt
			(DATA_DATE,DATA_HOUR,PU_ID,SERVICETYPE,TOT_CALL_CNT,TECH_MASK,NOTE)
			SELECT DATA_DATE,DATA_HOUR,PU_ID,SERVICETYPE,TOT_CALL_CNT,TECH_MASK,NOTE
			FROM ',GT_DB,'.table_call_cnt_',WORKER_ID,' 
			WHERE PU_ID = ',RNC_ID,' AND SERVICETYPE=''QR'' AND DATA_HOUR = ',DATAHOUR,'
			ON DUPLICATE KEY UPDATE
 			gt_gw_main.table_call_cnt.TOT_CALL_CNT=gt_gw_main.table_call_cnt.TOT_CALL_CNT ^ ',GT_DB,'.table_call_cnt_',WORKER_ID,' .TOT_CALL_CNT;');
 	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT(' DROP TEMPORARY TABLE IF EXISTS ',GT_DB,'.table_call_cnt_',WORKER_ID,' ;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;	
	

	INSERT INTO gt_gw_main.SP_LOG VALUES(GT_DB,'SP_Generate_Quarter_tablecallcnt',CONCAT('Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());
END
latin1
latin1_swedish_ci
latin1_swedish_ci
