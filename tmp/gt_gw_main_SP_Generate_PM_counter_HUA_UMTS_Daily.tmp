CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Generate_PM_counter_HUA_UMTS_Daily`(IN GT_DB VARCHAR(100))
a_label:
BEGIN
	DECLARE START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE O_GT_DB VARCHAR(100) DEFAULT GT_DB;
	DECLARE STARTHOUR VARCHAR(2) DEFAULT SUBSTRING(RIGHT(GT_DB,18),10,2);
	DECLARE ENDHOUR VARCHAR(2) DEFAULT IF(SUBSTRING(RIGHT(GT_DB,18),15,2)='00','24',SUBSTRING(RIGHT(GT_DB,18),15,2));
	DECLARE SH_EH VARCHAR(9) DEFAULT RIGHT(GT_DB,9);
	DECLARE WORKER_ID VARCHAR(10) DEFAULT CONNECTION_ID();
	DECLARE CURRENT_NT_DB VARCHAR(50) DEFAULT CONCAT('gt_nt_',gt_strtok(GT_DB,3,'_'));
	DECLARE DATA_DATE CHAR(8);
	DECLARE PROC_TIME DATETIME;
  	INSERT INTO gt_gw_main.SP_LOG VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily','Start', START_TIME);
 
	SELECT gt_strtok(GT_DB,3,'_') INTO DATA_DATE; 
	SELECT REPLACE(GT_DB,SH_EH,'0000_0000') INTO GT_DB;
	SELECT STR_TO_DATE(CONCAT(DATA_DATE, ' ', STARTHOUR), '%Y%m%d %H') INTO PROC_TIME;
 
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily','s1', NOW());
	SET @SqlCmd=CONCAT('DROP TABLE IF EXISTS ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'`');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	SET @SqlCmd=CONCAT('CREATE TABLE ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'` SELECT * FROM ',GT_DB,'.Table_pm_huawei_umts WHERE 1<>1');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	SET @SqlCmd=CONCAT('ALTER TABLE ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'` ADD PRIMARY KEY (RNC_NAME,CELL_ID,TIMESTAMP)');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	SET @SqlCmd=CONCAT('DELETE FROM ',GT_DB,'.`Table_pm_huawei_umts` WHERE `TIMESTAMP` = ''',PROC_TIME,''';');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily','s2', NOW());
	SET @SqlCmd=CONCAT('REPLACE INTO ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'`
			(`RNC_NAME`,`CELL_ID`,`TIMESTAMP`,
			`67179299`,`67179298`,`67179329`,`67179330`,`67179331`,`67179332`,
			`67179333`,`67179334`,`67179335`,`67179336`,`67179337`,`67179457`,
			`67179458`,`67179459`,`67179460`,`67179461`,`67179462`,`67179463`,
			`67179464`,`67179465`,
			`67179777`,`67179778`,`67179779`,`67179780`,`67179781`,`67179782`,`67179825`,`67179826`,`67179827`,`67179828`,
			`67179921`,`67179922`,`67179923`,`67179924`,`67179925`,`67179926`,`67179927`,`67179928`,`67184200`,`67184201`,
			`67189754`,`67189755`	
			)
		SELECT
			A.`RNC_NAME`,A.`CELL_ID`,A.`TIMESTAMP`,
			A.`67179299`,A.`67179298`,A.`67179329`,A.`67179330`,A.`67179331`,A.`67179332`,
			A.`67179333`,A.`67179334`,A.`67179335`,A.`67179336`,A.`67179337`,A.`67179457`,
			A.`67179458`,A.`67179459`,A.`67179460`,A.`67179461`,A.`67179462`,A.`67179463`,
			A.`67179464`,A.`67179465`,
			B.`67179777`,B.`67179778`,B.`67179779`,B.`67179780`,B.`67179781`,B.`67179782`,B.`67179825`,B.`67179826`,B.`67179827`,B.`67179828`,
			B.`67179921`,B.`67179922`,B.`67179923`,B.`67179924`,B.`67179925`,B.`67179926`,B.`67179927`,B.`67179928`,B.`67184200`,B.`67184201`,
			B.`67189754`,B.`67189755`
		FROM ',GT_DB,'.table_pm_67109365 A LEFT JOIN ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'` B
		ON A.RNC_NAME = B.RNC_NAME AND A.CELL_ID = B.CELL_ID AND A.TIMESTAMP = B.TIMESTAMP
		WHERE A.`TIMESTAMP` = ''',PROC_TIME,'''
		;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily','s3', NOW());
	SET @SqlCmd=CONCAT('REPLACE INTO ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'`
			(`RNC_NAME`,`CELL_ID`,`TIMESTAMP`,
			`67179825`,`67179826`,`67179827`,`67179828`,
			`67179299`,`67179298`,`67179329`,`67179330`,`67179331`,`67179332`,`67179333`,`67179334`,`67179335`,
			`67179336`,`67179337`,`67179457`,`67179458`,`67179459`,`67179460`,`67179461`,`67179462`,`67179463`,
			`67179464`,`67179465`,`67179777`,`67179778`,`67179779`,`67179780`,`67179781`,`67179782`,`67179921`,
			`67179922`,`67179923`,`67179924`,`67179925`,`67179926`,`67179927`,`67179928`,`67184200`,`67184201`,
			`67189754`,`67189755`
			)
		SELECT
			A.`RNC_NAME`,A.`CELL_ID`,A.`TIMESTAMP`,
			A.`67179825`,A.`67179826`,A.`67179827`,A.`67179828`,
			B.`67179299`,B.`67179298`,B.`67179329`,B.`67179330`,B.`67179331`,B.`67179332`,B.`67179333`,B.`67179334`,B.`67179335`,
			B.`67179336`,B.`67179337`,B.`67179457`,B.`67179458`,B.`67179459`,B.`67179460`,B.`67179461`,B.`67179462`,B.`67179463`,
			B.`67179464`,B.`67179465`,B.`67179777`,B.`67179778`,B.`67179779`,B.`67179780`,B.`67179781`,B.`67179782`,B.`67179921`,
			B.`67179922`,B.`67179923`,B.`67179924`,B.`67179925`,B.`67179926`,B.`67179927`,B.`67179928`,B.`67184200`,B.`67184201`,
			B.`67189754`,B.`67189755`
		FROM ',GT_DB,'.table_pm_67109368 A LEFT JOIN ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'` B
		ON A.RNC_NAME = B.RNC_NAME AND A.CELL_ID = B.CELL_ID AND A.TIMESTAMP = B.TIMESTAMP
		WHERE A.`TIMESTAMP` = ''',PROC_TIME,'''
		;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily','s4', NOW());
	SET @SqlCmd=CONCAT('REPLACE INTO ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'`
			(
			`RNC_NAME`,`CELL_ID`,`TIMESTAMP`,
			`67179921`,`67179922`,`67179923`,`67179924`,`67179925`,`67179926`,`67179927`,`67179928`,
			`67179299`,`67179298`,`67179329`,`67179330`,`67179331`,`67179332`,`67179333`,`67179334`,
			`67179335`,`67179336`,`67179337`,`67179457`,`67179458`,`67179459`,`67179460`,`67179461`,
			`67179462`,`67179463`,`67179464`,`67179465`,`67179777`,`67179778`,`67179779`,`67179780`,
			`67179781`,`67179782`,`67179825`,`67179826`,`67179827`,`67179828`,`67184200`,`67184201`,
			`67189754`,`67189755`
			)
		SELECT
			A.`RNC_NAME`,A.`CELL_ID`,A.`TIMESTAMP`,
			A.`67179921`,A.`67179922`,A.`67179923`,A.`67179924`,A.`67179925`,A.`67179926`,A.`67179927`,A.`67179928`,
			B.`67179299`,B.`67179298`,B.`67179329`,B.`67179330`,B.`67179331`,B.`67179332`,B.`67179333`,B.`67179334`,
			B.`67179335`,B.`67179336`,B.`67179337`,B.`67179457`,B.`67179458`,B.`67179459`,B.`67179460`,B.`67179461`,
			B.`67179462`,B.`67179463`,B.`67179464`,B.`67179465`,B.`67179777`,B.`67179778`,B.`67179779`,B.`67179780`,
			B.`67179781`,B.`67179782`,B.`67179825`,B.`67179826`,B.`67179827`,B.`67179828`,B.`67184200`,B.`67184201`,
			B.`67189754`,B.`67189755`
		FROM ',GT_DB,'.table_pm_67109372 A LEFT JOIN ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'` B
		ON A.RNC_NAME = B.RNC_NAME AND A.CELL_ID = B.CELL_ID AND A.TIMESTAMP = B.TIMESTAMP
		WHERE A.`TIMESTAMP` = ''',PROC_TIME,'''
		;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily','s5', NOW());
	SET @SqlCmd=CONCAT('REPLACE INTO ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'`
			(
			`RNC_NAME`,`CELL_ID`,`TIMESTAMP`,
			`67179777`,`67179778`,`67179779`,`67179780`,`67179781`,`67179782`,
			`67179299`,`67179298`,`67179329`,`67179330`,`67179331`,`67179332`,
			`67179333`,`67179334`,`67179335`,`67179336`,`67179337`,`67179457`,
			`67179458`,`67179459`,`67179460`,`67179461`,`67179462`,`67179463`,
			`67179464`,`67179465`,`67179825`,`67179826`,`67179827`,`67179828`,
			`67179921`,`67179922`,`67179923`,`67179924`,`67179925`,`67179926`,
			`67179927`,`67179928`,`67184200`,`67184201`,`67189754`,`67189755`
			)
		SELECT
			A.`RNC_NAME`,A.`CELL_ID`,A.`TIMESTAMP`,
			A.`67179777`,A.`67179778`,A.`67179779`,A.`67179780`,A.`67179781`,A.`67179782`,
			B.`67179299`,B.`67179298`,B.`67179329`,B.`67179330`,B.`67179331`,B.`67179332`,
			B.`67179333`,B.`67179334`,B.`67179335`,B.`67179336`,B.`67179337`,B.`67179457`,
			B.`67179458`,B.`67179459`,B.`67179460`,B.`67179461`,B.`67179462`,B.`67179463`,
			B.`67179464`,B.`67179465`,B.`67179825`,B.`67179826`,B.`67179827`,B.`67179828`,
			B.`67179921`,B.`67179922`,B.`67179923`,B.`67179924`,B.`67179925`,B.`67179926`,
			B.`67179927`,B.`67179928`,B.`67184200`,B.`67184201`,B.`67189754`,B.`67189755`
		FROM ',GT_DB,'.table_pm_67109376 A LEFT JOIN ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'` B
		ON A.RNC_NAME = B.RNC_NAME AND A.CELL_ID = B.CELL_ID AND A.TIMESTAMP = B.TIMESTAMP
		WHERE A.`TIMESTAMP` = ''',PROC_TIME,'''
		;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily','s6', NOW());
	SET @SqlCmd=CONCAT('REPLACE INTO ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'`
			(
			`RNC_NAME`,`CELL_ID`,`TIMESTAMP`,
			`67189754`,`67189755`,
			`67179299`,`67179298`,`67179329`,`67179330`,`67179331`,`67179332`,
			`67179333`,`67179334`,`67179335`,`67179336`,`67179337`,`67179457`,
			`67179458`,`67179459`,`67179460`,`67179461`,`67179462`,`67179463`,
			`67179464`,`67179465`,`67179777`,`67179778`,`67179779`,`67179780`,
			`67179781`,`67179782`,`67179825`,`67179826`,`67179827`,`67179828`,
			`67179921`,`67179922`,`67179923`,`67179924`,`67179925`,`67179926`,
			`67179927`,`67179928`,`67184200`,`67184201`
			)
		SELECT
			A.`RNC_NAME`,A.`CELL_ID`,A.`TIMESTAMP`,
			A.`67189754`,A.`67189755`,
			B.`67179299`,B.`67179298`,B.`67179329`,B.`67179330`,B.`67179331`,B.`67179332`,
			B.`67179333`,B.`67179334`,B.`67179335`,B.`67179336`,B.`67179337`,B.`67179457`,
			B.`67179458`,B.`67179459`,B.`67179460`,B.`67179461`,B.`67179462`,B.`67179463`,
			B.`67179464`,B.`67179465`,B.`67179777`,B.`67179778`,B.`67179779`,B.`67179780`,
			B.`67179781`,B.`67179782`,B.`67179825`,B.`67179826`,B.`67179827`,B.`67179828`,
			B.`67179921`,B.`67179922`,B.`67179923`,B.`67179924`,B.`67179925`,B.`67179926`,
			B.`67179927`,B.`67179928`,B.`67184200`,B.`67184201`
		FROM ',GT_DB,'.table_pm_67109381 A LEFT JOIN ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'` B
		ON A.RNC_NAME = B.RNC_NAME AND A.CELL_ID = B.CELL_ID AND A.TIMESTAMP = B.TIMESTAMP
		WHERE A.`TIMESTAMP` = ''',PROC_TIME,'''
		;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily','s7', NOW());
	SET @SqlCmd=CONCAT('UPDATE ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'` A, ',CURRENT_NT_DB,'.nt_rnc_current B
			SET
				A.RNC_ID = B.RNC_ID
				,A.DATA_DATE = DATE(TIMESTAMP)
				,A.DATA_HOUR = HOUR(TIMESTAMP)
			WHERE A.`RNC_ID` IS NULL AND A.RNC_NAME = B.RNC_NAME;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	INSERT INTO gt_gw_main.sp_log VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily','s8', NOW());
	SET @SqlCmd=CONCAT('INSERT INTO ',GT_DB,'.Table_pm_huawei_umts SELECT * FROM ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'`;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;		
	SET @SqlCmd=CONCAT('DROP TABLE IF EXISTS ',GT_DB,'.`tmp_Table_pm_huawei_umts_',WORKER_ID,'`');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(O_GT_DB,'SP_Generate_PM_counter_HUA_UMTS_Daily',CONCAT('Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());
	
END
utf8
utf8_general_ci
latin1_swedish_ci
