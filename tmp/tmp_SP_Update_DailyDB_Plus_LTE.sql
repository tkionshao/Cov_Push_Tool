CREATE DEFINER=`covmo`@`%` PROCEDURE `SP_Update_DailyDB_Plus_LTE`(IN O_GT_DB VARCHAR(50), IN DAILY_DB VARCHAR(100),TECH_MASK SMALLINT(4))
BEGIN	
        DECLARE START_TIME DATETIME DEFAULT SYSDATE();
	DECLARE GT_DB_DATE VARCHAR(100) ;	
	DECLARE GT_DB VARCHAR(100) ;
	DECLARE PU_ID VARCHAR(100);
	DECLARE GT_DB_YYYYMMDD VARCHAR(100) DEFAULT SUBSTRING(RIGHT(DAILY_DB ,18),1,8);
	DECLARE STARTHOUR VARCHAR(2) DEFAULT SUBSTRING(RIGHT(DAILY_DB,18),10,2);
	DECLARE ENDHOUR VARCHAR(2) DEFAULT IF(SUBSTRING(RIGHT(DAILY_DB,18),15,2)='00','24',SUBSTRING(RIGHT(DAILY_DB,18),15,2));	
	
	SET SESSION max_heap_table_size = 1024*1024*1024*4; 
	SET SESSION tmp_table_size = 1024*1024*1024*4; 
	SET SESSION join_buffer_size = 1024*1024*1024; 
	SET SESSION sort_buffer_size = 1024*1024*1024; 
	SET SESSION read_buffer_size = 1024*1024*1024; 
    
        SET GT_DB_DATE :=CONCAT(SUBSTR(GT_DB_YYYYMMDD,1,4),'-',SUBSTR(GT_DB_YYYYMMDD,5,2),'-',SUBSTR(GT_DB_YYYYMMDD,7,2));
        SET PU_ID =gt_strtok(DAILY_DB,2,'_');
        
       	INSERT INTO gt_gw_main.SP_LOG VALUES(O_GT_DB,'SP_Update_DailyDB_Plus','Start', START_TIME);
	
	SET @SqlCmd =CONCAT(' SELECT COUNT(*) INTO  @V_CNT FROM ',DAILY_DB,'.report_insert_log WHERE TEMP_DB=''',O_GT_DB,''' LIMIT 1;');
	PREPARE Stmt FROM @SqlCmd;
	EXECUTE Stmt;
	DEALLOCATE PREPARE Stmt;	
	
	WHILE @V_CNT >0 DO
		
		SET @SqlCmd =CONCAT(' SELECT TEMP_TBL_NAME INTO  @V_TEMP_TBL_NAME FROM ',DAILY_DB,'.report_insert_log WHERE TEMP_DB=''',O_GT_DB,''' LIMIT 1;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;	
	
		SET @SqlCmd =CONCAT('DROP TABLE IF EXISTS ',DAILY_DB,'.',@V_TEMP_TBL_NAME ,';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		SET @SqlCmd =CONCAT('DELETE FROM  ',DAILY_DB,'.report_insert_log WHERE TEMP_TBL_NAME=''',@V_TEMP_TBL_NAME ,''';');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
		
		SET @SqlCmd =CONCAT(' SELECT COUNT(*) INTO  @V_CNT FROM ',DAILY_DB,'.report_insert_log WHERE TEMP_DB=''',O_GT_DB,''' LIMIT 1;');
		PREPARE Stmt FROM @SqlCmd;
		EXECUTE Stmt;
		DEALLOCATE PREPARE Stmt;
	
	END WHILE;
	
	
	
	
	
	INSERT INTO gt_gw_main.SP_LOG VALUES(O_GT_DB,'SP_Update_DailyDB_Plus',CONCAT('Done: ',TIMESTAMPDIFF(SECOND,START_TIME,SYSDATE()),' seconds.'), NOW());
